<!--这版 markdown 之后手动 copy 到四份 word 文件中吗，之后如有要求均在 word 中修改-->
title: 一种可重构电池系统最大许用电流计算方法

# 权利要求书

1. 一种可重构电池系统最大许用电流计算方法，其特征在于，包括以下步骤：

**步骤1：** 定义可重构电池系统中的电池数量为$N_b$，开关数量为$N_s$，基于该系统的电池和开关连接关系，构建其有向图模型；

**步骤2：** 根据步骤1中构建的有向图模型，以开关状态为变量，流经电流不超过各电池许用电流为约束条件，可重构系统输出电流为目标函数，建立优化模型；

**步骤3：** 根据步骤1中构建的有向图模型，对每个电池分别求解对应的最短通路，其中通路$p$的距离通过下式计算得到：
$$
   \omega(p) = N_s n_b (p) + n_s (p),
$$
其中，$n_b$为该通路包含的电池数量，$n_s$为该通路包含的开关数量；

**步骤4：** 设选取的最短通路数量为$N_{\text{set}}$，其初始值为$N_b$；

**步骤5：** 从步骤3中求解得到的各电池最短通路中组合选取$N_{\text{set}}$条通路，生成$C^{N_{\text{set}}}_{N_b}$种组合方式；

**步骤6：** 对步骤5中生成的每一种组合方式，将被选入通路的开关状态设置为闭合，其余开关状态设置为断开，获得重构后的电路结构；

**步骤7：** 对步骤6中重构的每一种电路结构，带入步骤2中建立的优化模型，求解得到系统在闭合$N_{\text{set}}$条通路时的最大许用电流；

**步骤8：** 使用二分法更新步骤4中的$N_{set}$的值，重复步骤5至步骤7，直至获得系统最大许用电流。

2. 如权利要求1所述的可重构电池系统最大许用电流计算方法，其特征在于，所述步骤1中的“基于该系统的电池和开关连接关系，构建其有向图模型”进一步包括以下内容：

- 该有向图模型中的节点为可重构电池系统相邻电池和开关之间的连接点；
- 该有向图模型中的边为可重构电池系统中的电池、开关和外部负载，其中电池用从电池负极指向电池正极的有向边表示，开关用一对方向相反的有向边表示，外部负载用从系统正极指向负极的有向边表示；
- 每条有向图模型中的边都被分配了两个属性，分别为电压差和电阻，其中代表电池的边具有属性$(u_b,r_b)$，分别为电池电动势和内阻；代表开关的边具有属性$(0,r_s)$，$r_s$ 为开关电阻；代表外部负载的边具有属性$(0,R_o)$，$R_o$ 为外部负载的等效电阻。

1. 如权利要求1所述的可重构电池系统最大许用电流计算方法，其特征在于，所述步骤2中的“根据步骤1中构建的有向图模型，以开关状态为变量，流经电流不超过各电池许用电流为约束条件，可重构电池系统输出电流为目标函数，建立优化模型”进一步包括以下内容：

**步骤31：** 根据**步骤1**中构建的有向图模型，按以下关系确定关联矩阵$\bm{A}$：
$$
   a_{kl}=
   \begin{cases}
      1,  & \text{边$l$离开节点$k$},\\
      -1, & \text{边$l$进入节点$k$},\\
      0,  & \text{其他};
   \end{cases}
$$

**步骤32：** 对关联矩阵 $\bm{A}$ 进行整理和化简：
- 略去 $\bm{A}$ 的最后一行，得到退化关联矩阵$\tilde{\bm{A}}$；
- 将表示电池的列，按有向图中电池顺序排列，得到子矩阵$\tilde{\bm{A}_b}$；
- 将表示开关的列，按有向图中开关顺序排列，对表示相同开关的两列，仅保留其中一列，得到子矩阵$\tilde{\bm{A}_s}$；
- 将表示外部负载的列，单独作为子矩阵$\tilde{\bm{A}_o}$；

**步骤33：** 按以下关系建立系统开关状态矩阵$X_s$：
$$
   x_{ij}=
   \begin{cases}
      1,  & \text{$i=j$，第$i$个开关闭合},\\
      0,  & \text{$i=j$，第$i$个开关断开},\\
      0,  & \text{$i\neq j$};
   \end{cases}
$$

**步骤34：** 通过系统各电池的电流矩阵$\bm{I}_b$用下式计算得到：
$$
   \bm{I}_b = \frac{1}{r_b^2}[\tilde{\bm{A}_b}^\mathrm{T} \bm{Y}_n^{-1}(\bm{X}_s) \tilde{\bm{A}_b} \bm{U}_b -r_b \bm{U}_b],
$$
其中，$r_b$为电池内阻，$\bm{U}_b$是由各电池的电压组成的列向量，$\bm{Y}_n$为系统节点电导矩阵，由下式计算得到：
$$
   \bm{Y}_n (\bm{X}_s) = \frac{1}{R_o} \tilde{\bm{A}_o}\tilde{\bm{A}_o}^\mathrm{T} + \frac{1}{r_b} \tilde{\bm{A}_b} \tilde{\bm{A}_b}^\mathrm{T} + \frac{1}{r_s}\tilde{\bm{A}_s} \bm{X}_s \tilde{\bm{A}_s}^\mathrm{T};
$$

**步骤35：** 系统的输出电流$I_o$用下式计算得到：
$$
   I_o = \frac{1}{R_o r_b}\tilde{\bm{A}_b}^\mathrm{T} \bm{Y}_n^{-1}(\bm{X}_s) \tilde{\bm{A}_b} \bm{U}_b;
$$

**步骤36：** 基于**步骤34**和**步骤35**，最终得到如下形式的优化模型：
$$
\mathrm{max}\qquad I_o(X_s)
$$

$$
\text{s.t.}\quad \bm{I}_b (X_s)\leq \bm{I}_{b,m},
$$
其中，$\bm{I}_{b,m}$ 是由各电池的最大许用电流组成的列向量。

1. 如权利要求1所述的可重构电池系统最大许用电流计算方法，其特征在于，所述步骤8中的“使用二分法更新步骤4中的$N_{set}$的值”进一步包括以下内容：
- 若当前系统最大许用电流值大于前一循环系统许用电流值，则使用二分法向上更新整数$N_{set}$的值；
- 若当前系统最大许用电流值等于前一循环系统许用电流值，则终止计算，输出系统最大许用电流值；
- 若当前系统最大许用电流值小于前一循环系统许用电流值，则使用二分法向下更新整数$N_{set}$的值。

# 说明书

## 所属技术领域

本发明提出一种可重构电池系统最大许用电流计算方法，属于储能领域。

## 背景技术

可重构电池系统以其灵活的电路拓扑结构和高可靠性而受到越来越多的关注。
在可重构电池系统中，电池和开关形成的复杂连接结构为设计和控制提供了灵活性，但也带来了挑战。
与固定输出的传统电池储能系统不同，可重构电池系统的输出通过控制开关状态来动态调整，以满足外部负载需求。
错误的开关控制策略可能导致电池短路或过载，从而危及整个系统。
最大允许电流是可重构电池系统的重要性能指标，可以指导设计人员解决这个问题。
当前，可重构电池系统的最大允许电流通常通过手动计算得到，这种方法耗时且容易出错，无法满足实际应用的需求。
因此，迫切需要一种通用且自动计算可重构电池系统最大允许电流的方法。

## 发明内容

为解决现有技术中可重构电池系统最大许用电流计算方法耗时且容易出错的问题，本发明提出一种可重构电池系统最大许用电流计算方法，能够自动计算可重构电池系统最大许用电流，具有通用性。

一种可重构电池系统最大许用电流计算方法，具体包括如下步骤：

**第一步：** 设待求解的可重构电池系统中电池数量为$N_b$，开关数量为$N_s$。基于该系统的电池和开关连接关系，构建其有向图模型；

具体地，该有向图模型中的节点为可重构电池系统相邻电池和开关之间的连接点；边为可重构电池系统中的电池、开关和外部负载，其中电池用从电池负极指向电池正极的有向边表示，开关用一对方向相反的有向边表示，外部负载用从系统正极指向负极的有向边表示；每条有向图模型中的边都被分配了两个属性，分别为电压差和电阻，其中代表电池的边具有属性$(u_b,r_b)$，分别为电池电动势和内阻，代表开关的边具有属性$(0,r_s)$，$r_s$ 为开关电阻，代表外部负载的边具有属性$(0,R_o)$，$R_o$ 为外部负载的等效电阻。


**第二步：** 根据第一步中构建的有向图模型，以开关状态为变量，流经电流不超过各电池许用电流为约束条件，可重构系统输出电流为目标函数，建立优化模型。
首先，根据**第一步**中构建的有向图模型，按以下关系确定关联矩阵$A$：
$$
   a_{kl}=
   \begin{cases}
      1,  & \text{边$l$离开节点$k$},\\
      -1, & \text{边$l$进入节点$k$},\\
      0,  & \text{其他}.
   \end{cases}
$$
其次，对关联矩阵 $\bm{A}$ 进行整理和化简：略去 $\bm{A}$ 的最后一行，得到退化关联矩阵$\tilde{\bm{A}}$；将表示电池的列，按有向图中电池顺序排列，得到子矩阵$\tilde{\bm{A}_b}$；将表示开关的列，按有向图中开关顺序排列，对表示相同开关的两列，仅保留其中一列，得到子矩阵$\tilde{\bm{A}_s}$；将表示外部负载的列，单独作为子矩阵$\tilde{\bm{A}_o}$；

接着，按以下关系建立系统开关状态矩阵$X_s$：
$$
   x_{ij}=
   \begin{cases}
      1,  & \text{$i=j$，第$i$个开关闭合},\\
      0,  & \text{$i=j$，第$i$个开关断开},\\
      0,  & \text{$i\neq j$};
   \end{cases}
$$

然后，用下式计算通过系统各电池的电流矩阵$\bm{I}_b$：
$$
   \bm{I}_b = \frac{1}{r_b^2}[\tilde{\bm{A}_b}^\mathrm{T} \bm{Y}_n^{-1}(\bm{X}_s) \tilde{\bm{A}_b} \bm{U}_b -r_b \bm{U}_b],
$$
其中，$r_b$为电池内阻，$\bm{U}_b$是由各电池的电压组成的列向量，$\bm{Y}_n$为系统节点电导矩阵，由下式计算得到：
$$
   \bm{Y}_n (\bm{X}_s) = \frac{1}{R_o} \tilde{\bm{A}_o}\tilde{\bm{A}_o}^\mathrm{T} + \frac{1}{r_b} \tilde{\bm{A}_b} \tilde{\bm{A}_b}^\mathrm{T} + \frac{1}{r_s}\tilde{\bm{A}_s} \bm{X}_s \tilde{\bm{A}_s}^\mathrm{T};
$$
用下式计算系统的输出电流$I_o$用下式计算得到：
$$
   I_o = \frac{1}{R_o r_b}\tilde{\bm{A}_b}^\mathrm{T} \bm{Y}_n^{-1}(\bm{X}_s) \tilde{\bm{A}_b} \bm{U}_b;
$$
最终得到如下形式的优化模型：
$$
\mathrm{max}\qquad I_o(X_s)
$$

$$
\text{s.t.}\quad \bm{I}_b (X_s)\leq \bm{I}_{b,m},
$$
其中，$\bm{I}_{b,m}$ 是由各电池的最大许用电流组成的列向量。


**第三步：** 根据步骤1中构建的有向图模型，对每个电池分别求解对应的最短通路，其中通路$p$的距离通过下式计算得到：
$$
   \omega(p) = N_s n_b (p) + n_s (p),
$$
其中，$n_b$为该通路包含的电池数量，$n_s$为该通路包含的开关数量。


**第四步：** 设选取的最短通路数量为$N_{\text{set}}$，其初始值为$N_b$。


**第五步：** 从第四步中求解得到的各电池最短通路中组合选取$N_{\text{set}}$条通路，生成$C^{N_{\text{set}}}_{N_b}$种组合方式。


**第六步：** 对第五步中生成的每一种组合方式，将被选入通路的开关状态设置为闭合，其余开关状态设置为断开，获得重构后的电路结构；

**第七步：** 对第六步中重构的每一种电路结构，带入第二步中建立的优化模型，求解得到系统在闭合$N_{\text{set}}$条通路时的最大许用电流；

**第八步：** 使用二分法更新第四步中的$N_{set}$的值：若当前系统最大许用电流值大于前一循环系统许用电流值，则使用二分法向上更新整数$N_{set}$的值；若当前系统最大许用电流值等于前一循环系统许用电流值，则终止计算，输出系统最大许用电流值；若当前系统最大许用电流值小于前一循环系统许用电流值，则使用二分法向下更新整数$N_{set}$的值；重复第五步至第七步，直至获得系统最大许用电流。


## 附图说明

图1为本发明实施例的可重构电池系统最大许用电流计算方法的步骤流程图。

图2为本发明实施例的待求解可重构电池系统的电路图。

图3为本发明实施例的可重构电池系统最大许用电流计算过程中的具有物理信息的有向图模型。

图4为本发明实施例的可重构电池系统最大许用电流计算过程中的最短通路求解结果。

图5为本发明实施例的可重构电池系统最大许用电流计算的计算结果。

## 具体实施方式

下面结合附图说明及具体实施案例对本发明提出的可重构电池系统最大许用电流计算方法进行进一步说明。

如图1所示，一种可重构电池系统最大许用电流计算方法，包括以下步骤：

S1. 本实施例中，以图2所示的具有4个电池和19个开关的可重构电池系统为计算对象，即$N_b=4$，$N_s=19$。
构建有向图，以相邻电池和开关之间的连接点为节点；以电池、开关和外部负载为边，其中电池用从电池负极指向电池正极的有向边表示，开关用一对方向相反的有向边表示，外部负载用从系统正极指向负极的有向边表示；每条有向图模型中的边都被分配了两个属性，分别为电压差和电阻，其中代表电池的边具有属性$(u_b,r_b)$，分别为电池电动势和内阻，代表开关的边具有属性$(0,r_s)$，$r_s$ 为开关电阻，代表外部负载的边具有属性$(0,R_o)$，$R_o$ 为外部负载的等效电阻。
在本示例中，系统中电池的内阻$r_b=50\,\mathrm{m\Omega}$，外部负载的电阻$R_o=2\,\Omega$，开关的内阻为$r_s=0.1\,\mathrm{m\Omega}$，电池最大寻用电流$I_{b,\mathrm{max}}=5\,\mathrm{A}$，电池电压$U_b=3.6\,\mathrm{V}$。


S2. 根据图3所建立的具有物理信息的有向图模型，退化关联矩阵$\tilde{A}$为：
$$
\tilde{\bm{A}}=[\tilde{\bm{A}}_b\,\tilde{\bm{A}}_s\,\tilde{\bm{A}}_o],
$$
$$
\tilde{\bm{A}}_b=
\begin{pmatrix}
   0  &  0  &  0  &  0  &  1  &  0  & -1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
   0  &  0  &  0  &  0  &  0  &  1  &  0  & -1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
   0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  1  &  0  & -1  &  0  &  0  &  0 \\
   0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  1  &  0  & -1  &  0  &  0 \\
\end{pmatrix} ^ \text{T},
$$
$$
\tilde{\bm{A}}_s=
\begin{pmatrix}
    1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
   -1  &  1  &  1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
    0  & -1  &  0  &  1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
    0  &  0  & -1  &  0  &  1  &  1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
    0  &  0  &  0  &  0  & -1  &  0  &  1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
    0  &  0  &  0  &  0  &  0  & -1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
    0  &  0  &  0  &  0  &  0  &  0  &  0  &  1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
    0  &  0  &  0  &  0  &  0  &  0  & -1  &  0  &  1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
    0  &  0  &  0  &  0  &  0  &  0  &  0  & -1  & -1  &  1  &  1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
    0  &  0  &  0  & -1  &  0  &  0  &  0  &  0  &  0  & -1  &  0  &  1  &  0  &  0  &  0  &  0  &  0  &  0  &  0 \\
    0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  & -1  &  0  &  1  &  1  &  0  &  0  &  0  &  0  &  0 \\
    0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  & -1  &  0  &  1  &  0  &  0  &  0  &  0 \\
    0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  & -1  &  0  &  0  &  0  &  0  &  0 \\
    0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  1  &  0  &  0  &  0 \\
    0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  & -1  &  0  &  1  &  0  &  0 \\
    0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  & -1  & -1  &  1  &  1 \\
    0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  & -1  &  0  &  0  &  0  &  0  &  0  & -1  &  0 \\
\end{pmatrix},
$$
$$
\tilde{\bm{A}}_o=
\begin{pmatrix}
    -1  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0  &  0
\end{pmatrix} ^\text{T},
$$
设系统中$N_s$个开关的状态为$X_s$。
系统中$N_b$个电池的电流用下式计算得到：
$$
   \bm{I}_b = \frac{1}{r_b^2}[\tilde{\bm{A}_b}^\mathrm{T} \bm{Y}_n^{-1}(\bm{X}_s) \tilde{\bm{A}_b} \bm{U}_b -r_b \bm{U}_b],
$$
其中，$Y_n(X_s)$通过下式计算得到：
$$
   \bm{Y}_n (\bm{X}_s) = \frac{1}{R_o} \tilde{\bm{A}_o}\tilde{\bm{A}_o}^\mathrm{T} + \frac{1}{r_b} \tilde{\bm{A}_b} \tilde{\bm{A}_b}^\mathrm{T} + \frac{1}{r_s}\tilde{\bm{A}_s} \bm{X}_s \tilde{\bm{A}_s}^\mathrm{T};
$$
系统的输出电流用下式计算得到：
$$
   I_o = \frac{1}{R_o r_b}\tilde{\bm{A}_b}^\mathrm{T} \bm{Y}_n^{-1}(\bm{X}_s) \tilde{\bm{A}_b} \bm{U}_b;
$$
最后，得到如下形式的优化模型：
$$
\mathrm{max}\qquad I_o(X_s)
$$

$$
\text{s.t.}\quad \bm{I}_b (X_s)\leq 5\,\mathrm{A}.
$$


S3. 对图3中的4个电池按照下式，分别求解对应的最短通路：
$$
\omega(p) = 19 \cdot n_b (p) + n_s (p),
$$
其中，$n_b$为通路中电池数量，$n_s$为通路中开关的数量。
求解结果如图4所示。

S4. 设选取的最短通路数量为$N_{set}=4$，其初始值为$N_b=4$。

S5. 从图4中求解得到的4条最短通路中组合选取$N_{\text{set}}$条通路，生成$C^{N_{\text{set}}}_{N_b}=C^4_4=1$种组合方式。

S6. 对S5中生成的每一种组合方式，将被选入通路的开关状态设置为闭合，其余开关状态设置为断开，获得重构后的电路结构。

S7. 从S6中重构的每一种电路结构，带入第二步中建立的优化模型，求解得到系统在闭合$4$条通路时的最大许用电流。

S8. 使用二分法更新第四步中的$N_{set}$的值：若当前系统最大许用电流值大于前一循环系统许用电流值，则使用二分法向上更新整数$N_{set}$的值；若当前系统最大许用电流值等于前一循环系统许用电流值，则终止计算，输出系统最大许用电流值；若当前系统最大许用电流值小于前一循环系统许用电流值，则使用二分法向下更新整数$N_{set}$的值。重复S5至S7，直至获得系统最大许用电流。


最终得到本实例中的系统最大许用电流值为$1.78\,\mathrm{A}$，对应的开关闭合方式如图5所示。

# 说明书附图

![](../attachments/专利-流程图.png)
图1

![](../attachments/arch-fe.png)
图2

![](../attachments/direct-graph-my.png)
图3

![](../attachments/all-sp.png)
图4

![](../attachments/ef-mac.png)
图5

# 说明书摘要

本发明公开了一种可重构电池系统最大许用电流的计算方法。
其主要步骤如下：
（1）基于电池和开关之间的连接关系构建有向图模型；
（2）以开关状态为变量、电池流经电流不超过电池许用电流为约束条件、系统输出电流为目标函数，建立优化模型；
（3）对有向图模型中的各电池分别求解对应的最短通路；
（4）选择一定数量的最短通路，形成出一系列重构后的电路结构，带入优化模型，求解得到此条件下的最大许用电流值；
（5）更新被选最短通路的数量，重复上述步骤，直至求解得到系统的最大许用电流值。
本发明提出的方法能够计算任意可重构电池系统的最大许用电流值，可应用于指导可重构电池系统的设计和优化，评估系统在实际运行中的电流过载风险。
