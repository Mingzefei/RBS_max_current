Ao=sparse([1],[1],[-1],8,1);
Ab=sparse([3,4,5,6,6,7],[1,2,1,2,3,3],[1,1,-1,-1,1,-1],8,3);
As=sparse([1,2,2,2,3,4,5,7,8,8,8],[1,1,2,3,2,3,4,5,4,5,6],[1,-1,1,1,-1,-1,1,1,-1,-1,1]);
A=[Ao Ab As];
Ro=sym('Ro','positive'); % for out
rb=sym('rb','positive'); % battery internal resistance
rs=sym('rs','positive'); % switch resistance
ub=sym('ub','positive'); % battery electric potential
% rb=0.1; % battery internal resistance
% Ro=10; % for out
% rs=rb*1e-6; % switch resistance
% ub=3; % battery electric potential

switch_state=[1,1,1,1,1,1];
x=diag(switch_state);
Us=[0,-ub*ones(1,3),zeros(1,6)]';
Ub=[-ub;-ub;-ub];
Yo=diag(1/Ro);
Yb=diag([1,1,1]/rb);
Ys=diag(ones(1,6)/rs)*x;
Y=diag([1/Ro,ones(1,3)/rb,switch_state/rs]);
Yn=A*Y*A';
Isn=A*Y*Us;
Un=Yn\Isn;
U=A'*Un;
I=Y*U-Y*Us;
Io=simplify(I(1));
Ib=simplify(I(2:4));
Io_ideal=subs(Io,rs,0)
Ib_ideal=subs(Ib,rs,0)
