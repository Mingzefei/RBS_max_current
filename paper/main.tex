% 0622 v3.0 plan
% -[x] 将 word 批注和修改内容整理到 tex 中
% -[x] 确定修改要点，批注和obsidian记录

% 0623 v3.0 plan 具体修改计划
% !!!!!! 先改方法、后改案例、最后改介绍和其他
% -[ ] 题目 点明我们的普适性、自动化？
% -[x] 摘要 中间段重写；点明普适性、自动化
% -[x] introduction 
%      -[x] 只放 V的结构，并展示串联、并联和隔离；
%      -[-] 增加重构灵活性的文献；
%      -[-] 有向图的文献；
%      -[x] 点明普适性、自动化
% -[x] methodology 
%      -[x] main 图重画，只保留文字；
%      -[x] 有向图模型，说清三层关系，更规矩地写建模过程；
%      -[x] 优化目标和约束；
%      -[x] 最短路径，逐句逐字去捋顺；
%      -[x] 贪心算法，结合流程图说明算法过程，把二分法融进去；
%      -[x] 增加隔离的处理，如约束、算法的改动
% -[x] case study 
%      -[-] 考虑新结构（MAC=4，想不到就算了，仍用ef结构）(0626: 想不到)；
%      -[x] results 直接给出结果，略去计算细节；
%      -[x] discussion 说明eta的合理性；
%      -[-] 什么样的结构能获得更大的MAC（易隔离性和输出性能的冲突）（想不出来就算了）(0626:有想法，但是要引入互斥片段的概念)；
%      -[x] 电池隔离场景下的MAC变化(比较不同结构)

% keep in mind
% 1. 用最简洁、读者最能接受的话说明清楚自己想表达的内容

% mark
% 统一为 directed graph model
% 统一用 electrical load 而非 electrical appliance (泛指家电)

% magic
% 你将扮演一位英文学术写作经验丰富的大学老师，指导一位非英文母语的学生完成并改进他的论文。 你的目标是帮助他写出一篇流畅、清晰、易读、符合规范的英文学术论文。 他会向你用中文说明自己想表达的内容，有时还会给你一些不完整的英文句子让你补充完整。你不应该逐字翻译他的内容，你需要和他经过多次的沟通，以确定最好的表达。 注意，你们交流的内容可能包含latex语法，你需要理解并使用；当你形成完整的句子或段落时，你要将这些句子或段落放在```\n 和\n ```之间，即 ```\n some sentence\n ```，其中每写完一句话都要换行。

\documentclass{article}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{enumerate}
\usepackage{amsmath}
\DeclareMathOperator{\diag}{diag}
\usepackage{multirow}
\usepackage{booktabs}
\usepackage{bm}
\usepackage[ruled,linesnumbered]{algorithm2e}
\setcounter{MaxMatrixCols}{20}
\usepackage{tikz}
\usetikzlibrary{arrows.meta, calc, fit, positioning, quotes, graphs, shapes.geometric}
\def\T{\mathrm{T}}


\title{Maximum Allowable Current Determination of Arbitrary Reconfigurable Battery Systems By Using a Directed Graph Model Combined with Greedy Algorithm}

\author{3057761608 }

\begin{document}

\maketitle

\begin{abstract} % # TODO: check
    Reconfigurable Battery Systems (RBSs) offer a promising alternative to traditional battery systems owing to their flexible and dynamic changeable topologic structure subjected to battery charging and discharging strategies. 
    During the operation of the RBS, Maximum Allowable Current (MAC) is a critical indicator to guide the reconfiguring control of the system in terms of safety and reliability. 
    In this paper, the MAC of the RBS is calculated using a greedy algorithm combined with the directed graph model of the RBS.
    Based on the directed graph model, the algorithm guides the RBS to allow as many batteries to be connected in parallel as possible, thus maximizing the output current of the system while ensuring proper battery operation.
    The effectiveness of this method is validated on a novel and complex RBS structure.
    This method paves the way for next-generation RBS design and application, such as battery isolation.

    keywords:  Reconfigurable Battery System, Maximum Allowable Current, Directed Graph Model , Greedy Algorithm
\end{abstract}

\section{Introduction}

Battery Energy Storage Systems (BESSs) are widely used to store and release high-quality electrical energy in various applications, such as smart grids and wind power plants \cite{desiqueiraControlStrategySmooth2021,karandehTwoStageAlgorithmOptimal2019,yangBatteryEnergyStorage2018,choCommercialResearchBattery2015}.
Typically, a BESS consists of numerous batteries that are interconnected by series-parallel circuitry to provide the required capacity storage.
The traditional BESS, in which the batteries are connected in a fixed topology, has a significant weakness on its worst battery, caused by the so-called cask effect.
Furthermore, if this worst battery is failed during the operation process, it will exacerbate the degradation of the other batteries with a high possibility, and arouse reliability and even safety issues \cite{yangUnbalancedDischargingAging2016,fengPropagationMechanismsDiagnosis2019}. % #TODO: 放些 space 电池组的文献


Reconfigurable Battery System (RBS), which can dynamically switch to different circuit topology configurations as required, is expected to solve the above problem\cite{hanNextGenerationBatteryManagement2020a}.
The ability of switching circuit helps to isolate unhealthy batteries, and thereby improve the safety and reliability of the battery system.
Fig.\ref{fig:stru-Visairo} shows a typical RBS structure developed by Visairo \cite{visairoReconfigurableBatteryPack2008} for dynamically adjusting the output voltage and current.
In this structure, the batteries can be connected not only in series when the switches $S_1$, $S_5$, $S_6$, $S_7$, $S_8$, $S_9$, and $S_{13}$ are closed (Fig.\ref{fig:stru-Visairo-serial}), but also in parallel when $S_1$, $S_2$, $S_3$, $S_4$, $S_5$, $S_9$, $S_{10}$, $S_{11}$, $S_{12}$, and $S_{13}$ are closed (Fig.\ref{fig:stru-Visairo-parallel}).
Furthermore, when an unhealthy battery, for instance the orange one $B_3$ in Fig.\ref{fig:stru-Visairo-isolate}, appears in the RBS, it can be isolated by opening its two adjacent switches (i.e. $S_4$ and $S_{11}$), ensuring the system still remains a reliable working mode.

\begin{figure}[htbp] % #TODO: V 的结构示意图
    \centering
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/arch-f.png} % 完整结构
        \caption{}
        \label{fig:stru-Visairo}
    \end{subfigure}
    \hspace{0.05\textwidth}
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/arch-f.png} % 全串联
        \caption{}
        \label{fig:stru-Visairo-serial}
    \end{subfigure}
    \\
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/arch-f.png} % 全并联
        \caption{}
        \label{fig:stru-Visairo-parallel}
    \end{subfigure}
    \hspace{0.05\textwidth}
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/arch-f.png} % 电池隔离 右二 B3 全并联
        \caption{}
        \label{fig:stru-Visairo-isolate}
    \end{subfigure}
    \caption{
        (a) The RBS structure proposed by Visairo\cite{visairoReconfigurableBatteryPack2008}, with
        all batteries in (b) series connection, (c) parallel connection, and
        (d) battery $B_3$ isolated.
        }
    \label{fig:arch}
\end{figure}

The complex connection structure between batteries and switches in the RBS provides flexibility but also introduces challenges in design and operational control. 
Unlike traditional BESSs with fixed outputs, the RBS output must be dynamically adjusted by controlling switch states to meet external load requirements. 
This necessitates additional, time-consuming output performance analysis during design and corresponding control strategies. 
An incorrect switch control strategy may cause battery short-circuiting or overload, risking the entire system. 
The Maximum Allowable Current (MAC), an RBS performance indicator, can guide designers in addressing this issue. 
MAC is defined as the maximum RBS output current that ensures each battery's current remains within a safe range.
Therefore, it provides a benchmark for RBS output current, protecting individual batteries and identifying overall system output limits during operation. 
Despite its importance, no method currently exists for automatically evaluating MAC for RBSs.
In particular, when one or more random cells are isolated, there is still no method to determine the MAC of the remaining RBS in time to assist the system in adjusting the control strategy timely. 
A universal and automatical method for calculating RBS MAC is urgently needed for practical applications. 
In this study, a directed graph model and greedy algorithm are employed to determine the MAC of RBS and the corresponding control strategy, effectively calculating the MAC for RBSs with arbitrary structures, including scenarios with isolated batteries.


The remainder of this paper is organized as follows: 
Section II presents the framework and details of the proposed directed graph model and the greedy algorithm. 
Section III demonstrated a case study of using the proposed method to determine the MAC of a novel and complex structure. 
The calculation results and scenarios such as batteries isolation also are discussed. 
Finally, the concluding remarks are drawn in Section IV.

\section{Methodology}

The central principle of this method is to make the batteries in RBS connected in series as much as possible, thereby maximizing the output current of the RBS.
To universally and automatically achieve this, the overall process is divided into four steps, as shown in Fig.\ref{fig:main}.
Firstly, a directed graph model is established for subsequent computing, which not only contains the connected relationships between batteries and switches, but also retains the performance parameters of the batteries.
Subsequently, based on the equivalent circuit, the MAC problem is transformed into specific objective functions and constraints.
Then, the shortest paths (SPs, where additional batteries and switches on the path are penalized as distance) for the batteries are obtained using the Dijkstra algorithm to guide the batteries in the RBS connect in series.
Finally, a greedy algorithm is employed to organize the switches, allowing the batteries to connect via their SPs while satisfying the constraints, resulting in the MAC of the RBS.

\begin{figure}[htbp]
    \centering
    \begin{subfigure}[b]{0.8\textwidth}
        \includegraphics[width=\textwidth]{../attachments/main.png} % #TODO: 修改step2中的公式
        \caption{}
        \label{fig:main}
    \end{subfigure}
    \caption{ 
        Diagram of this method, which contains four main steps.
    }
\end{figure}

\subsection{Directed graph Model}

\begin{figure}[htbp]
    \centering
    \begin{subfigure}[b]{0.31\textwidth}
        \includegraphics[width=\textwidth]{../attachments/direct-graph-he.png}
        \caption{}
        \label{fig:direct-graph-he}
    \end{subfigure}
    \hspace{0.02\textwidth}
    \begin{subfigure}[b]{0.23\textwidth}
        \includegraphics[width=\textwidth]{../attachments/direct-graph-xu.png}
        \caption{}
        \label{fig:direct-graph-xu}
    \end{subfigure}
    \hspace{0.02\textwidth}
    \begin{subfigure}[b]{0.24\textwidth}
        \includegraphics[width=\textwidth]{../attachments/direct-graph-my.png} % #TODO: 蓝色线段由实变虚
        \caption{}
        \label{fig:direct-graph-my}
    \end{subfigure}
    \\
    \begin{subfigure}[b]{0.8\textwidth}
        \includegraphics[width=\textwidth]{../attachments/battery_simple.png}
        \caption{}
        \label{fig:battery_simple}
    \end{subfigure}
    \caption{ 
        Directed graph models used in (a) He's work \cite{heExploringAdaptiveReconfiguration2013}, (b) our previous work , and (c) this paper.
        (d) The equivalent circuit of a battery in this method.
    }
\end{figure}

He et al. \cite{heExploringAdaptiveReconfiguration2013} once proposed an abstracted directed graph model for RBS, where the nodes represented the batteries, the edges represented the configuration flexibility, and the weight of each vertex corresponded to the battery voltage ( Fig.\ref{fig:direct-graph-he}). 
The model effectively captured all potential system configurations and offered a direct metric for configuration flexibility, but it did not specify the physical implementation of the connectivity between batteries, meaning one graph might have had multiple RBS structures.
We previously proposed a novel directed graph model that, in contrast to He's model, used nodes to represent the connections between batteries and switches, and directed edges to represent batteries and switches (Fig.\ref{fig:direct-graph-xu}), allowing for a one-to-one correspondence between the RBS structure and the directed graph model. 
This model was able to accurately and comprehensively represent the RBS topological structure but could not be used for quantitative MAC calculations due to the lack of consideration for battery and switch performance parameters. 
To address this, an improved directed graph model is used here based on our original model, adding electromotive force and resistance attributes on the edges based to equivalent circuits (Fig.\ref{fig:direct-graph-my}).
The model also considers the external load as an equivalent resistance and integrate it into the analysis, making it a complete circuit model for later circuit analysis.
The following will provide a detailed explanation of the method for equating the components in RBS and constructing the directed graph model.


In order to use circuit analysis methods to solve the MAC of the RBS, the components in the RBS are equated to ideal circuit elements.
As shown in Fig.\ref{fig:battery_simple}, the battery in the RBS can be represented as a black-box circuit consisting of two resistors (i.e., $r_1$ and $r_2$) and a capacitor (i.e., $C$), known as the Thevenin model\cite{hongwenheStateofChargeEstimationLithiumIon2011,mousavig.VariousBatteryModels2014}.
With an emphasis on the stable output of the RBS, the capacitor in the Thevenin model can be considered as an open circuit without affecting the steady-state current.
Therefore, the battery $i$ in the RBS can be simplified as the series connection between a constant voltage source $u_{i}$ and a resistor $r_{i}$.
Furthermore, the state of switch $j$ in the RBS is represented by a binary variable $x_j$, where 0 is for ON and 1 is for OFF, respectively.
When the switch is closed, it can be regarded as a resistor with a very small resistance value $r_{j}$.
Lastly, the external load is considered as a resistor with a value of $R_o$.


For a given RBS structure, the directed graph model for the RBS is constructed as a directed graph $G(V,E)$ in such a way that:
\begin{enumerate}
    \item Nodes:
        The nodes in the directed graph correspond to the connection points of components in the actual RBS. 
        Assuming there are a total of $N$ nodes in the RBS, for the sake of convenience, the anode of the RBS is denoted as $v_1$ and the cathode as $v_N$.
    \item Edges:
        The edges in the directed graph correspond to the batteries, switches, and external electrical loads in the actual RBS.
        Therefore, there are three types of directed edges. 
        For a battery $B_i$, its directed edge $e_i$ is drawn from the cathode to the anode, as the battery only allows current to flow in one direction when in operation.
        For a switch $S_j$, since it is allowed to work under bi-directional currents, it is represented by a pair of directed edges with two-way directions. 
        Regarding the external electronic load, as it is connected to the anode and cathode of the RBS, a directed edge from $v_N$ to $v_1$ is used to represent it. 
        In conclusion, for a given RBS structure with $N_b$ batteries and $N_s$ switches, the total number of directed edges is $N_b+2N_s+1$, where 1 refers to the external electrical load.
    \item Edges' attributes:
        Each edge is assigned two attributes, voltage difference and resistance, based on the equivalent method mentioned above.
        The values for the battery $B_i$, switch $S_j$, and external loads correspond to $(u_i, r_i)$, $(0, r_j)$, and $(0, R_o)$, respectively.
\end{enumerate}

\subsection{Constraints and Objective Function}

Based on the definition of MAC, determining the MAC of RBS involves maximizing the RBS output current while ensuring that the currents of all batteries do not exceed the batteries' maximum allowable current. 
In this subsection, the constraints and objective function to solve the RBS's MAC will be established through circuit analysis, based on the previously constructed directed graph model.


First, the topology in the directed graph model is represented in matrix form $\bm{A}$, known as the incidence matrix , to facilitate circuit analysis.
The specific definition of the incidence matrix is shown in Eq.\ref{eq:A}.
\begin{align}\label{eq:A}
    a_{kl}=
    \begin{cases}
        1,  & \text{edge $l$ leaves node $k$},\\
        -1, & \text{edge $l$ enters node $k$},\\
        0,  & \text{otherwise}.
    \end{cases}
\end{align}
For a directed graph consisting of $N$ nodes and $N_b+2N_s+1$ directed edges, its incidence matrix $\bm{A}$ is an $N\times(N_b+2N_s+1)$ matrix. 
In this matrix, the rows and columns represent the nodes and edges of the directed graph, respectively.
By distinguishing the components in the RBS corresponding to each column , $\bm{A}$ can be rewritten as:
\begin{equation}\label{eq:A_bso}
    \bm{A} =
    \begin{bmatrix}
        \bm{A}_b & \bm{A}_s & \bm{A}_o
    \end{bmatrix},
\end{equation}
where $\bm{A}_b$, $\bm{A}_s$ and $\bm{A}_o$ are the sub-matrices corresponding to the batteries, switches and external electrical load, respectively.
To alleviate computational complexity, matrix $\bm{A}$ undergoes dimensionality reduction.
Since each directed edge has one node to leave and one to enter, the sum of the values in every column of $\bm{A}$ is zero.
Therefore removing any single one row will not result in a loss of information. 
Without loss of generality, the last row is removed here.
On the other hand, since each switch in the RBS is represented by a pair of directed edges with two-way directions, the two columns corresponding to the switch are mutually opposite.
Thus, for the sub-matrix $\bm{A}_s$, only one column is retained for each pair of columns representing the same switch.
As a result, $\bm{A}$ can be reduced to a $(N-1)\times(N_b+N_s+1)$ matrix, denoted as $\bm{\tilde{A}}$, for further calculation of current and voltage.
Similar to Eq.\ref{eq:A_bso}, $\bm{\tilde{A}}$ can be rewritten as:
\begin{equation}\label{eq:A_bso_tilde}
    \bm{\tilde{A}} =
    \begin{bmatrix}
        \bm{\tilde{A}}_b & \bm{\tilde{A}}_s & \bm{\tilde{A}}_o
    \end{bmatrix}.
\end{equation}


After obtaining the incidence matrix, the currents of all batteries and output in RBS are determined by solving the circuit equations.
According to Kirchhoffs law, we have
\begin{align}\label{eq:Kirchhoffs_law}
    \begin{cases}
        \bm{\tilde{A}} \bm{I} = \bm{0}, \\
        \bm{U}        = \bm{\tilde{A}}^\T \bm{U}_n,
    \end{cases}
\end{align}
where $\bm{I}$ and $\bm{U}$ indicate the current and voltage difference arrays of the $N_b+N_s+1$ edges, respectively;
$\bm{U}_n$ is the voltage array of the $N-1$ nodes.
These directed edges are treated as generalized branches and expressed in matrix form as follows
\begin{equation}\label{eq:generalized_branches}
    \bm{I} = \bm{Y}\bm{X} \bm{U} - \bm{Y}\bm{X} \bm{U}_s +\bm{I}_s,
\end{equation}
where $\bm{U}_s$ and $\bm{I}_s$ denote the source voltage and source current of the generalized branches, respectively.
Because all batteries have been equivalent to voltage sources rather than current sources in the previous subsection, all elements of the array $\bm{I}_s$ are 0, 
while the elements of the array $\bm{U}_s$ are equal to the first attribute of the corresponding edges in the directed graph.
The $\bm{Y}$ in \ref{eq:generalized_branches} is the admittance matrix of the circuit, defined as the inverse of the impedance matrix.
That is the elements of the diagonal matrix $\bm{Y}$ are equal to the reciprocal of the second attribute of the corresponding edges in the directed graph, and the off-diagonal elements are 0.
The $\bm{X}$ is the state matrix, which describes whether the RBS batteries and switches are allowed to pass current.
It is defined as
\begin{equation}\label{eq:X}
    \bm{X} = \diag(
    \underbrace{1, 0 \cdots, 1}_{N_b~\text{of}~0/1},
    \underbrace{1, 0 \cdots, 1}_{N_s~\text{of}~0/1},
    1)
    =\begin{bmatrix}
        \bm{X}_b & & \\
        & \bm{X}_s &\\
        & & 1
    \end{bmatrix}.
\end{equation}
Where the elements $x_i$ of the matrix $\bm{X}_b$ represent whether the battery $i$ has been removed from the circuit, with $x_i=1$ indicating removal and $x_i=0$ indicating that it is still available to supply power. 
When all batteries are health and capable of providing current to the external load, $\bm{X}_b$ is an identity matrix. 
The elements $x_j$ of the matrix $\bm{X}_s$ represent whether the switch $j$ is closed, with $x_j=1$ indicating closure and $x_j=0$ indicating disconnection, which is consistent with the previous subsection.


Theoretically, the output current $I_o$ and the currents of each battery $\bm{I}_b$ in the RBS  can be determined by solving Eqs.\ref{eq:Kirchhoffs_law}, \ref{eq:generalized_branches}, and \ref{eq:X} under any given state $\bm{X}$.
In order to obtain specific constraint conditions and objective functions, it is further assumed that all batteries have the same electromotive force and internal resistance, denoted as $u_b$ and $r_b$, respectively.
This allows for the derivation of explicit expressions for $I_o$ and $\bm{I}_b$.
After derivation and simplification, the output current $I_o$ and the currents of each battery $\bm{I}_b$ are ultimately represented as Eqs.\ref{eq:I_o} and \ref{eq:I_b}, respectively.
\begin{equation}\label{eq:I_o}
    I_o = \frac{1}{R_o r_b} \bm{\tilde{A}}_o^\T \bm{Y}_n^{-1}(\bm{X}) \bm{\tilde{A}}_b \bm{U}_b,
\end{equation}
\begin{equation}\label{eq:I_b}
    \bm{I}_b = \frac{1}{r_b^2}[\bm{\tilde{A}}_b^\T \bm{Y}_n^{-1}(\bm{X}) \bm{\tilde{A}}_b\bm{U}_b -r_b \bm{U}_b],
\end{equation}
where $\bm{U}_b$ is a $N_b\times 1$ array with all elements equaling to $u_b$;
$\bm{Y}_n$ is the equivalent admittance matrix of the circuit, defined as
\begin{equation}\label{eq:Yn}
    \bm{Y}_n (\bm{X}) = \frac{1}{R_o} \bm{\tilde{A}}_o\bm{\tilde{A}}_o^\T + \frac{1}{r_b} \bm{\tilde{A}}_b\bm{X}_b\bm{\tilde{A}}_b^\T + \frac{1}{r_s}\bm{\tilde{A}}_s\bm{X}_s\bm{\tilde{A}}_s^\T.
\end{equation}


To characterize the current output capacity of the RBS structure under different switching states, an indicator $\eta$ is defined by the ratio of $I_o$ and $\max (\bm{I}_b)$ shown in Eq.\ref{eq:eta}:
\begin{equation}\label{eq:eta}
    \eta = \frac{I_o}{\max (\bm{I}_b)}.
\end{equation}
Finally the problem of solving MAC can be formulated as
\begin{align}
    & \max \eta(\bm{X}_s) \label{eq:max_eta}\\
    \text{s.t.} & \max (\bm{I}_b) \leq I_m, \label{eq:Ib_leq_Im}
\end{align}
where $I_m$ is the maximum allowable current of the battery.


However, it is computationally difficult to solve \ref{eq:max_eta} because of the $\bm{Y}_n^{-1}$.
On one hand, due to the introduction of nonlinear terms by $\bm{Y}_n^{-1}$, many effective methods in linear optimization are not suitable for this problem.
On the other hand, the rank of $Y_{n}$ is proportional to the number of batteries and switches, which can be very large for a large RBS system, leading to significant computational burden.
Therefore, intelligent algorithms that rely on evolving by iteration may face efficiency issues when dealing with large RBS system.
% 如果有时间，可以在案例部分做个对比，看看智能算法和本文算法的效率差距有多大。
In order to address this issue, the problem should be considered from the perspective of guiding the RBS to reconstruct as many parallel structures as possible.
Consequently, a greedy algorithm based on the shortest path is proposed. 
The detailed implementation process is presented in the following two subsections.

% Herein provides the solution procedure of …: 1. 2.
% 考虑这部分怎么写，想不出就直接删了吧。
% The integrability of the matrix $\bm{Y}_n$ is explained here.
% Although the above solution procedure requires the matrix $\bm{Y}_n$ to be invertible, it is still possible to encounter integrable $\bm{Y}_n$ in the calculation.
% The physical meaning of this case corresponds to the fact that due to the excessive number of switches in OFF, the solved circuit structure forms circuit branches independent of the main circuit, i.e., the circuit connected to the anode and cathode of the RBS. 
% Since these independent branches are not connected to the main circuit, the voltage potentials of these branches cannot be determined and theoretically an infinite number of sets of solutions exist. 
% Benfit from the independence, these solutions have no influence on the results of the main circuit. 
% Since only the currents and voltages of the main circuit are of interest, only one of these solutions needs to be chosen for subsequent calculation.

\subsection{Shortest Path}

The path $p$ used in this method is defined as the complete route that passes through one battery (or a consecutive series of batteries) and closed switches, connecting the anode $v_1$ to the cathode $v_N$ of the RBS.
By applying a penalty to the series-connected batteries on the path, where additional batteries imply a longer distance, the algorithm encourages the RBS to form parallel structures as much as possible.
Meanwhile, to reduce the number of switches controlled during the reconstruction process, a penalty is also applied to the total number of switches on the path, while ensuring the minimum number of batteries.
Therefore, the distance $\omega$ of the path $p$ is defined by the following equation: 
\begin{equation}\label{eq:weight}
    \omega(p) = N_s \cdot n_b (p) + n_s (p),
\end{equation}
where $N_s$ is the total number of switches in the system; 
$n_b(p)$ and $n_s(p)$ are number of batteries and switches in the path $p$ respectively. 
Moreover, the shortest path $SP_i$ is defined as the path with the minimum $\omega$ for battery $i$, as shown in the following equation:
\begin{equation}\label{eq:def_sp}
    SP_i = \mathop{\arg\min}_{p \in P_i} \omega(p),
\end{equation}
where $P_i$ is the set of all paths from $v_1$ to $v_N$ which pass through the directed edge $i$.


The $SP_i$ can be solved by the Dijkstra algorithm.
The Dijkstra algorithm is a graph search method that finds the shortest path between two given nodes in a weighted graph, efficiently solving the single-source shortest path problem.
Assuming that the cathode and anode of battery $i$ are denoted as $v_i^-$ and $v_i^+$ respectively, the path $p$ of battery $i$  can be divided into three segments : $v_1 \rightarrow v_i^-$, $v_i^+ \rightarrow v_N$, and $v_i^- \rightarrow v_i^+$.
The $v_i^- \rightarrow v_i^+$ is the directed edge corresponding to battery $i$. 
With the Dijkstra algorithm, shortest paths for the $v_1 \rightarrow v_i^-$ and $v_i^+ \rightarrow v_N$ can be calculated under the weights given in Eq.\ref{eq:weight}, denoted as $SP(v_i^- \rightarrow v_i^+)$ and $SP(v_i^+ \rightarrow v_N)$, respectively.
Finally, the $SP_i$ for battery $i$ is formed by the complete path with $SP(v_1 \rightarrow v_i^-)$, $v_i^- \rightarrow v_i^+$, and $SP(v_i^+ \rightarrow v_N)$.

\subsection{Greedy Algorithm}\label{subsec:greedy_solution}

From the perspective of series/parallel connections, integrating more batteries into the circuit through their shortest paths ($SP$s) results in a larger number of batteries connected in parallel, thereby increasing the total output current of the RBS.
However, conflicts may arise between the $SP$s of different batteries. 
For instance, the $SP$s of two batteries might form a short-circuited RBS structure, which is not allowed. 
To address this issue, a greedy algorithm is employed to incorporate as many $SP$s as possible while satisfying the reconstruction requirements.

The algorithm, as illustrated in Fig.\ref{fig:flowchart}, can be summarized as follows, with the corresponding pseudo-code presented in Algorithm \ref{alg:greedy}.
First, the shortest paths ($SP$s) are obtained using Eqs.\ref{eq:weight} and \ref{eq:def_sp} in conjunction with Dijkstra Search. 
Next, the matrix $\bm{A}$ is calculated using Eq.\ref{eq:A}, and the initial $N_{set}$ is set to $N_b$. 
The algorithm iteratively checks different combinations of $c_b$ batteries from $N_b$ and updates $N_{set}$ using a dichotomy method until convergence is reached. 
For each combination, the algorithm constructs an effective solution if possible, and calculates the currents $I_o$ and $\bm{I}_b$ using Eqs.\ref{eq:I_o} and \ref{eq:I_b}. 
If the maximum current $\bm{I}_b$ is less than or equal to $I_m$, the $\eta$ is calculated using Eq.\ref{eq:eta}, and the maximum $\eta$ is updated accordingly. 
Finally, the algorithm outputs the maximum $\eta$ once $N_{set}$ converges.

\tikzset{
  meta box/.style={draw, black, very thick, text centered, },
  punkt/.style={meta box, rectangle, rounded corners, inner sep=.25em, minimum height=2em, minimum width=4em, align=center, text width=10em },
  round/.style={meta box, circle, minimum size=0, inner sep=0pt, outer sep=0pt },
  every fit/.style={draw, thick, dashed, gray, inner xsep=.5em, inner ysep=.75em }
}
\begin{figure}
\begin{tikzpicture}[font=\small, node font=\small, node distance=1.5em]
    \node[punkt]     (input) {Input: RBS structure};
    \node[punkt, below=0.3of input] (get_SP) {get $SP$s by Eqs.\ref{eq:weight} and \ref{eq:def_sp} and Dijkstra Search};
    \node[punkt, below=0.3of get_SP] (get_A) {get $\bm{A}$ from Eq.\ref{eq:A}};
    \node[punkt, below=0.3of get_A] (get_Nset) {init $N_{set}=N_b$ };
    \node[punkt, below=0.3of get_Nset] (get_cb) {get $c_b$s by combinating $N_{set}$ batteries from $N_b$};
    \node[draw, diamond, aspect=2, below=0.3of get_cb] (is_check_all_cb) {are all $c_b$s checked?};
    \node[draw, diamond, aspect=2, right=1of is_check_all_cb] (is_Nset_converged) {is $N_{set}$ converged?};
    \node[punkt, above=of is_Nset_converged] (reset_Nset) {reset $N_{set}$ by dichotomy};
    \node[punkt, text width=15em, below=0.3of is_check_all_cb] (get_Xs) {
        select an unchecked $c_b$, and get its $\bm{X}_m$ by \\ 
        if switch $j$ $\in \bigcup_{i\in c_b}SP_i$:\\
        $\bm{X}[j]=1$ else $0$};
    \node[punkt, below=0.3of get_Xs] (get_Yn) {get $\bm{Y}_n$ by Eq.\ref{eq:Yn}};
    \node[draw, diamond, aspect=2, below=0.3of get_Yn] (is_Yn_invertible) {is $\bm{Y}_n$ invertible?};
    \node[punkt, right=1.3of is_Yn_invertible] (construct) {construct an effective solution};
    \node[punkt, below=0.3of is_Yn_invertible] (get_I) {get $I_o$ and $\bm{I}_b$ by Eqs.\ref{eq:I_o} and \ref{eq:I_b}};
    \node[draw, diamond, aspect=2, below=0.3of get_I] (is_leq_Im) {is $\max \bm{I}_b \leq I_m$?};
    \node[punkt, right=1.3of is_leq_Im] (drop_eta) {drop this $\eta$};
    \node[punkt, below=0.3of is_leq_Im] (get_eta) {get $\eta$ by Eq.\ref{eq:eta}};
    \node[punkt, below=0.3of get_eta] (update_max_eta) {update $\max \eta$};
    \node[punkt, right=1of is_Nset_converged] (output) {Output: $\max \eta$};
    \node[round,left=1.5of update_max_eta](point1){};

    \graph{
      (input) -> (get_SP) -> (get_A) -> (get_Nset) -> (get_cb) -> (is_check_all_cb) ->["No"] (get_Xs) -> (get_Yn) -> (is_Yn_invertible) ->["Yes"] (get_I) -> (is_leq_Im) ->["Yes"] (get_eta) -> (update_max_eta);
      (is_check_all_cb) ->["Yes"] (is_Nset_converged) ->["No"] (reset_Nset) -> (get_cb);
      (is_Yn_invertible) ->["No"] (construct) ->[to path={|- (\tikztotarget)}] (get_I);
      (is_leq_Im) ->["No"] (drop_eta) ->[to path={|- (\tikztotarget)}] (update_max_eta);
      (is_Nset_converged) ->["Yes"] (output);
      (update_max_eta) -- (point1) ->[to path={|- (\tikztotarget)}] (is_check_all_cb);
    };
\end{tikzpicture}
\caption{The computational flowchart of the MAC for a given RBS.}\label{fig:flowchart}
\end{figure}

\section{Case Study}

\subsection{Structures}

\begin{figure}[htbp]
    \centering
    \begin{subfigure}[b]{0.2\textwidth}
        \includegraphics[width=\textwidth]{../attachments/arch-e.png} % #TODO: 把不健康电池改为健康
        \caption{}
        \label{fig:study-stru-Lawson}
    \end{subfigure}
    \hspace{0.02\textwidth}
    \begin{subfigure}[b]{0.4\textwidth}
        \includegraphics[width=\textwidth]{../attachments/arch-f.png}
        \caption{}
        \label{fig:study-stru-Visairo}
    \end{subfigure}
    \hspace{0.02\textwidth}
    \begin{subfigure}[b]{0.31\textwidth}
        \includegraphics[width=\textwidth]{../attachments/arch-ef.png} % #TODO: 去掉虚线框
        \caption{}
        \label{fig:study-stru-my}
    \end{subfigure}
    \caption{The 4-battery RBS structures proposed by (a)Lawson\cite{lawsonSoftwareConfigurableBattery2012}, (b)Visairo\cite{visairoReconfigurableBatteryPack2008} and (c)this paper.}
\end{figure}

Currently, two types of RBS structures have been proposed by Visairo et al. \cite{visairoReconfigurableBatteryPack2008} and Lawson et al. \cite{lawsonSoftwareConfigurableBattery2012}, both of which have been applied in practice. 
The primary goal of Visairo's structure (Fig.\ref{fig:study-stru-Visairo}) was to achieve dynamic adjustment of RBS output; however, the isolation of unhealthy batteries was not sufficiently addressed. 
When batteries need to be isolated in the RBS of Visairo's structure, the methods for isolating them and the subsequent changes in RBS output warrant further investigation.
Lawson et al. conducted research on battery isolation in RBS and specifically designed the structure shown in Fig.\ref{fig:study-stru-Lawson}. 
This structure has the advantage of easily isolating batteries, but it cannot dynamically adjust the output current of RBS. 
Based on the structures of Visairo and Lawson, this paper presents a new structure, as shown in Fig.\ref{fig:study-stru-my}, which combines the advantages of both.
By integrating the Visairo RBS structure into the Lawson RBS structure, the new structure not only allows the flexibility to switch the batteries between series, parallel, and mixed series-parallel modes, but also easily enables the isolation of highly degraded batteries from the RBS.
And their variations in output current under battery isolation conditions will be studied.
This RBS structure will be used to validate the effectiveness of the proposed method for calculating the MAC, and be compared with the Lawson's and Visairo's structure to illustrate its advantage on battery isolation.

\subsection{Result}

As shown in Fig.\ref{fig:study-stru-my}, the new RBS structure consists of 4 batteries and 19 switches. 
The corresponding directed graph is depicted in Fig.\ref{fig:study-dirgraph-my}, which is composed of of a total of 18 nodes and 43 edges. 
Batteries $B_1$, $B_2$, $B_3$, and $B_4$ are denoted by green directed edges in the graph, while the 19 switches are represented by gray directed edges with bi-directional arrows. 
The external electrical load is treated as a directed edge from the cathode of the RBS (i.e., node 18) to the anode (i.e., node 1), as indicated by the blue directed edge in the graph.
Utilizing Eq.\ref{eq:weight} and the Dijkstra algorithm, the $SP$s of the four batteries in the RBS structure of Fig.\ref{fig:study-stru-my} are highlighted by red in Figs.\ref{fig:sp1}-\ref{fig:sp4}.
Finally, the MAC calculation results of the structure in Fig.\ref{fig:study-stru-my} are shown as Tab.\ref{tab:study-results-my} and Fig.\ref{fig:study-results-my}, obtained by the greedy algorithm \ref{alg:greedy}.
Tab.\ref{tab:study-results-my} contains the switches states, the output current $I_o$, battery current $\bm{I}_b$ and ratio $\eta$ of the RBS structure with all batteries in good health when the RBS output reaches the MAC.
Fig.\ref{fig:study-results-my} presents the corresponding circuit, with the red highlight indicating that current is flowing through the respective branches.

\begin{figure}[htbp] % #TODO：补上两个开关
    \centering
    \begin{subfigure}[b]{0.28\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-topo.png} % #TODO：补上两个开关
        \caption{}
        \label{fig:study-dirgraph-my}
    \end{subfigure}
    \hspace{0.05\textwidth}
    \begin{subfigure}[b]{0.28\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-sp1.png}
        \caption{}
        \label{fig:sp1}
    \end{subfigure}
    \hspace{0.05\textwidth}
    \begin{subfigure}[b]{0.28\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-sp2.png}
        \caption{}
        \label{fig:sp2}
    \end{subfigure}
    \\
    \begin{subfigure}[b]{0.28\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-sp3.png}
        \caption{}
        \label{fig:sp3}
    \end{subfigure}
    \hspace{0.05\textwidth}
    \begin{subfigure}[b]{0.28\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-sp4.png}
        \caption{}
        \label{fig:sp4}
    \end{subfigure}
    \hspace{0.05\textwidth}
    \begin{subfigure}[b]{0.28\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-mac.png} % #TODO: 闭合开关。移除开关，直接连上
        \caption{}
        \label{fig:study-results-my}
    \end{subfigure}
    \caption{
        For the RBS structure in Fig.\ref{fig:study-stru-my}, 
        (a)its directed graph 
        and the $SP$s (highlighted in red) of battery (b)$B_1$, (c)$B_2$, (d)$B_3$, (e)$B_4$.
        (f)The circuit of the RBS with its output reaching the MAC.
        }
    \label{fig:all-results-my}
\end{figure}

\begin{table}[htbp]
  \centering
    \caption{MAC Calculating result of the 4-battery RBS structure in Fig.\ref{fig:study-stru-my}.}
    \begin{tabular}{cc}
    \toprule
        Structure & Fig.\ref{fig:study-stru-my} with 4 batteries and 19 switches  \\
    \midrule
    Switch ON & $S_1$,$S_3$,$S_5$,$S_6$,$S_8$,$S_9$,$S_{10}$,$S_{12}$,$S_{18}$,$S_{19}$ \\
    $I_o$ & $2u_b/(2R_o+r_b)$ \\
    $\bm{I}_b$ & $[u_b/(2R_o+r_b),u_b/(2R_o+r_b),0,0]$ \\
    $\eta$     & 2 \\
    \bottomrule
    \end{tabular}
  \label{tab:study-results-my}
\end{table}

Similarly, the MAC calculation results of the structures in Figs.\ref{fig:study-stru-Lawson} and \ref{fig:study-stru-Visairo} are shown as Tab.\ref{tab:study-results-Lawson} and Tab.\ref{tab:study-results-Visairo}, respectively.

\begin{table}[htbp]
  \centering
    \caption{MAC Calculating result of the 4-battery RBS structure in Fig.\ref{fig:study-stru-Lawson}.}
    \begin{tabular}{cc}
    \toprule
        Structure & Fig.\ref{fig:study-stru-Lawson} with 4 batteries and 15 switches  \\
    \midrule
    Switch ON & $S_1$,$S_3$,$S_5$,$S_7$,$S_{10}$,$S_{13}$,$S_{14}$,$S_{15}$ \\
    $I_o$ & $u_b/(R_o+r_b)$ \\
    $\bm{I}_b$ & $[u_b/(R_o+r_b),0,0,0]$ \\
    $\eta$     & 1 \\
    \bottomrule
    \end{tabular}
  \label{tab:study-results-Lawson}
\end{table}

\begin{table}[htbp]
  \centering
    \caption{MAC Calculating result of the 4-battery RBS structure in Fig.\ref{fig:study-stru-Visairo}.}
    \begin{tabular}{cc}
    \toprule
        Structure & Fig.\ref{fig:study-stru-Visairo} with 4 batteries and 13 switches  \\
    \midrule
    Switch ON & $S_1$,$S_2$,$S_3$,$S_4$,$S_5$,$S_9$,$S_{10}$,$S_{11}$,$S_{12}$,$S_{13}$ \\
    $I_o$ & $4u_b/(4R_o+r_b)$ \\
    $\bm{I}_b$ & $[u_b/(4R_o+r_b),u_b/(4R_o+r_b),u_b/(4R_o+r_b),u_b/(4R_o+r_b)]$ \\
    $\eta$     & 4 \\
    \bottomrule
    \end{tabular}
  \label{tab:study-results-Visairo}
\end{table}

\subsection{Discussion}

In this subsection, we firstly discuss the correctness of the results presented in Fig.\ref{fig:all-results-my} and Tab.\ref{tab:study-results-my}. 
When $B_1$ and $B_2$ or $B_3$ and $B_4$ are connected in parallel, the RBS can output the maximum current, which is $\eta=2$, i.e., twice the current output of a single battery in RBS. 
Adding more batteries to the main circuit can only form a series structure and will not improve the MAC. 
Therefore, the switches state given in Tab.\ref{tab:study-results-my} can make the RBS output current reach the maximum.


It is important to note that when solving for MAC, $\eta$ is used as the objective function instead of $I_o$. 
This choice makes the result of MAC more reasonable. 
As shown in Tab.\ref{tab:study-results-my}, $I_o$ and $\bm{I}_b$ are functions of $R_o$, $u_b$, and $r_b$. 
If $I_o$ were used as the objective function, even for the same RBS structure, the MAC result and corresponding switches state could change due to different external electrical appliances.
It would increase the difficulty and uncertainty in RBS structure design. 
In contrast, by using $\eta$ as the objective function, which is defined as the ratio of $I_o$ and $\max\bm{I}_b$, the influence of these factors on the results can be eliminated. 
$\eta$ solely reflects the maximum output current capability of the RBS structure. 
Assuming that the maximum allowed current of batteries in the RBS is $I_m$, the maximum output current of the RBS structure can be calculated as $\eta I_m$ by determining the $\eta$ of the structure. 
Therefore, compared to $I_o$, $\eta$ is more suitable for structure design.


The method proposed in this paper is significant for the design of next-generation RBSs in the following aspects.
Most of the currently proposed RBS structures\cite{ciNovelDesignAdaptive2007,alahmadBatterySwitchArray2008,kimDependableEfficientScalable2010b,kimBalancedReconfigurationStorage2011a,taesickimSeriesconnectedSelfreconfigurableMulticell2012a,6843711} exhibit simple topological characteristics, and the calculation of MACs is relatively straightforward, even intuitive.
However, these simple structures do not always fully satisfy the requirements of complex applications, such as dynamically adapting the circuit to variable and random operating conditions, and actively equalizing differences among the batteries in the RBS.
Moreover, isolating the batteries disrupts the original regularity and symmetry of the topology, which complicates the otherwise simple structure, and the maximum output current of the system becomes more challenging to obtain.
Owing to the advantages of pervasiveness and automation, the proposed method can be employed to calculate the MAC of arbitrary RBS structures, which helps to address the aforementioned issues and paves the way for more complex and flexible RBS structure design.


To illustrate this point, the MACs of the three RBS structures mentioned above are calculated after the batteries are isolated, as shown in Fig.\ref{fig:isolated_mac}. 
Specifically, for the structure presented in Fig.\ref{fig:study-stru-my}, the corresponding circuit states of MACs when isolating different numbers of batteries are depicted in Figs.\ref{fig:my-isolated-1}-\ref{fig:my-isolated-3}. 
This structure has two cases of isolating two batteries: 
one is to isolate two batteries within the same substructure (Fig.\ref{fig:my-isolated-2b}), in which case $\eta=2$; the other is to isolate one battery in each of the two substructures (Fig.\ref{fig:my-isolated-2w}), in which case $\eta=1$. 
From the results, it can be observed that the proposed method provides reasonable outcomes for isolating batteries with any number and position.


Furthermore, the performance of output current for the three RBS when isolating batteries is also illustrated in Fig.\ref{fig:isolated_mac}. 
For the structure proposed by Lawson et al., the MAC remains the same as that without isolated battery cells, i.e., $\eta=1$, when the number of isolated battery cells increases, until all the cells in the RBS are isolated. 
For Visairo's structure, the MAC decreases as the number of isolated battery cells increases, until $\eta=0$. 
In contrast, the MAC of the structure proposed in this work is positioned between the two structures. 
This indicates that the structure proposed in this paper, compared to Lawson's structure, has a larger MAC under the same number of batteries, which means a wider output current regulation range. 
On the other hand, by simply changing the states of $S_2$, $S_4$, $S_{11}$, and $S_{12}$ in the conversion structure, this structure can address the majority of battery isolation scenarios, whereas Visairo's structure requires specific battery targeting and switch control. 
In summary, the structure proposed in this paper has the advantages of both Lawson's and Visairo's structures.

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.65\textwidth]{../attachments/isolated_mac.png}
    \caption{
        The variation of MAC with the number of isolated batteries for different RBS structures, including the structure proposed by Lawson et al., Visairo et al. , and the structure proposed in this paper.
    }\label{fig:isolated_mac}
\end{figure}

% 对 my 结构的具体示意图 #TODO
% 隔离1个 fig:my-isolated-1
% 隔离2个，最好的情况 fig:my-isolated-2b
% 隔离2个，最差的情况 fig:my-isolated-2w
% 隔离3个 fig:my-isolated-3

\section{Conclusion}

This paper proposes a pervasive and automatical method for computing the MAC of the given RBS.
The method is  implemented by a greedy algorithm combined with a directed graph model, whose effectiveness is tested on a novel and complex RBS structure.
The method remains effective for the application scenario of RBS battery isolation and demonstrates that the novel structure has the advantage on flexible output current and convenient battery isolation.
Future research could focus on developing new indictors to evaluate the performance of the RBS with the currents and voltages obtained by the method, as well as modifying the equivalent model of the battery to allow for more accurate simulations of the RBS, including transient analysis.

\newpage

\section{Appendix} 

\begin{algorithm}
    \caption{Get the max available currents of a certain RBS}\label{alg:greedy}
    \KwData{Directed graph model $G(V,E)$ of the RBS}
    \KwResult{$\max \eta$}
    \For{$i \in E_b$}{
        $P_i \leftarrow \{path| \text{starts at $v_1$ and ends at $v_n$} \}$\;
        $SP_i \leftarrow p_i \text{ which has the minimum}~\omega(p_i)~\text{among all}~p_i \in P_i. $
    }
    get $\bm{A}$ by Equation \ref{eq:A}\;
    \While{not yet determine $\max \eta$ }
    {
        $N_{set} \leftarrow \text{number of setected $SP$s calculated by dichotomy}$\;
        $C_b    \leftarrow \text{set of all combinations of $N_{set} $~batteries from $N_b$}$\;
        \For{$c_b \in C_b$}{
            $\bm{x}_s \leftarrow \text{list of all switches' state: $x_s[j]=1$ if $ j \in \bigcup_{i\in c_b}SP_i $ else 0}$\;
            $\bm{X} \leftarrow diag[1,1,\cdots,1,\bm{x}_s] $\;
            get $\bm{Y}_n$ by Equation \ref{eq:Yn}\;
            \eIf{$\bm{Y}_n$ is invertible}{
            }{construct an effective solution}
            get $I_o$ by Equation \ref{eq:I_o}\;
            get $\bm{I}_b$ by Equation \ref{eq:I_b}\;
            \eIf{$\max(\bm{I}_b)\leq I_m$}{
                $\eta \leftarrow I_o/\max(\bm{I}_b)$\;
            }{break}
        }
    }
\end{algorithm}

\section{Acknowledgement}
This work was supported by the National Natural Science Foundation of China (NSFC, No.52075028).

\bibliographystyle{ieeetr}
\bibliography{my_ref}

\end{document}
