% 0622 v3.0 plan
% -[ ] 将 word 批注和修改内容整理到 tex 中
% -[ ] 确定修改要点，批注和obsidian记录
% -[ ] 添加参考文献，期刊的 

% mark
% 统一为 directed graph model
% 统一用 electrical load 而非 electrical appliance (泛指家电)

\documentclass{article}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{enumerate}
\usepackage{amsmath}
\DeclareMathOperator{\diag}{diag}
\usepackage{multirow}
\usepackage{booktabs}
\usepackage{bm}
\usepackage[ruled,linesnumbered]{algorithm2e}
\setcounter{MaxMatrixCols}{20}
\usepackage{tikz}
\usetikzlibrary{
  arrows.meta,
  calc,
  fit,
  positioning,
  quotes,
  graphs,
  shapes.geometric
}
\def\T{\mathrm{T}}


\title{Maximum Allowable Current Determination of Arbitrary Reconfigurable Battery Systems By Using a Directed Graph Model Combined with Greedy Algorithm}
\author{3057761608 }

\begin{document}

\maketitle

\begin{abstract} % #TODO: rewrite
    Reconfigurable Battery Systems (RBSs) offer a promising alternative to traditional battery systems owing to their flexible and dynamic changeable topologic structure subjected to battery cell charging and discharging strategies. 
    During the operation of the RBS, Maximum Allowable Current (MAC) is a critical indicator to guide the reconfiguring control of the system in terms of safety and reliability. 
    In this paper, the MAC of the RBS is calculated by using a greedy algorithm based on the directed graph model of the RBS. % 这句话展开讲， Greedy algorithm方法被用于…/与…方法相结合，实现了对任意RBS结构的MAC提取，
    % The greedy algorithm method has been used to solve a model based on topology structure, achieving MAC estimation for any RBS structure.
    The effectiveness of this method is validated on a more complex RBS structure based on two proposed structure. 
    This proposed Greedy-based method paves the way for more flexible design and more complex application scenarios, such as battery cell isolation, for RBS.

    keywords:  Reconfigurable Battery System, Maximum Allowable Current, Greedy Algorithm
\end{abstract}

\section{Introduction}
% 不放案例
% 重构灵活性的文献
% 有向图的文献

Battery Energy Storage Systems (BESSs) are widely used to store and release high-quality electrical energy in various applications, such as smart grids and wind power plants \cite{desiqueiraControlStrategySmooth2021,karandehTwoStageAlgorithmOptimal2019,yangBatteryEnergyStorage2018,choCommercialResearchBattery2015}.
Typically, a BESS consists of numerous battery cells that are interconnected by series-parallel circuitry to provide the required capacity storage.
The traditional BESS, in which the batteries are connected in a fixed topology, has a significant weakness on its worst battery, caused by the so-called cask effect.
Furthermore, if this worst battery is failed during the operation process, it will exacerbate the degradation of the other batteries with a high possibility, and arouse reliability and even safety issues \cite{yangUnbalancedDischargingAging2016,fengPropagationMechanismsDiagnosis2019}.


Reconfigurable Battery System (RBS), which can dynamically switch to different circuit topology configurations as required, is expected to solve the above problem\cite{hanNextGenerationBatteryManagement2020a}.
The ability of switching circuit helps to isolate unhealthy batteries, and thereby improve the safety and reliability of the battery system.
Fig. \ref{fig:arch} shows two popular typologies of the RBSs developed by Lawson\cite{lawsonSoftwareConfigurableBattery2012} and Visairo \cite{visairoReconfigurableBatteryPack2008} respectively. 
Taking the RBS shown in Fig. \ref{fig:arch-e} as example, the batteries in the RBS can be connected not only in series when the switches $S_1$, $S_5$, $S_6$, $S_7$, $S_8$, $S_9$, and $S_{13}$ are closed, but also in parallel when $S_1$, $S_2$, $S_3$, $S_4$, $S_5$, $S_9$, $S_{10}$, $S_{11}$, $S_{12}$, and $S_{13}$ are closed.
Furthermore, when an unhealthy battery, for instance the orange one in Fig. \ref{fig:arch-f}, exits in the RBS, it can be isolated by closing its three adjacent switches (i.e. $S_5$, $S_7$ and $S_8$) and opening the switch below that battery (i.e. $S_6$) to ensure the system still remains a reliable working mode.
% 补充一句话总结，visairo的网络与固定串并联结构相比具有哪些优点，更适合使用在什么场合

\begin{figure}[htbp]
    \centering
    \begin{subfigure}[b]{0.2\textwidth}
        \includegraphics[width=\textwidth]{../attachments/arch-e.png}
        \caption{}
        \label{fig:arch-f}
    \end{subfigure}
    \hspace{0.05\textwidth}
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/arch-f.png}
        \caption{}
        \label{fig:arch-e}
    \end{subfigure}
    \caption{The RBS structure proposed by (a)Lawson\cite{lawsonSoftwareConfigurableBattery2012}, (b)Visairo\cite{visairoReconfigurableBatteryPack2008}.}
    \label{fig:arch}
\end{figure}

The complex connecting structure between batteries and switches enables the flexibility of the RBS, but on the other hand brings the challenges in desgin and control cost as well.
All switches of the RBS need to be controlled to output currents and powers that match the external load in read-time while avoiding batteries short-circuit.
The Maximum Allowable Current (MAC) of the RBS system is defined as the maximum current that is allowed for each individual battery of the system, and is a critical indictor to be evaluate the RBS output current to the electronic appliances.% 这里缺少过渡，MAC和设计与控制成本有什么关系？
It helps the designer to assess whether the RBS meets the output current requirements, and contributes to the formulation of appropriate and safe management stragegies for the battery management system (BMS). 
Despite its importance, there is currently no way to automatically evaluate MAC for RBSs. 
Especially when one (or more) stochastic battery is isolated, it is not possible to simultaneously determine the MAC of the rest of the RBS to assist the BMS to provide a timely adjustment of the control strategy. 
Under such circumstance, a universal and effective method for calculating the MAC of the RBS is urgently needed for the practical application of RBSs. 
To achieve this, a directed graph model that builds the relationship between RBS circuit topology and internal resistance and voltage of its batteries are established. 
Then, a greedy algorithm is employed to search the available circuit of the RBS for reaching the MAC.
% 以上两句话争取合并成一句话，提出的方法应该紧扣标题（即与标题的方法一致）
With this proposed method, the MAC of RBSs with arbitrary structures can be calculated effectively, including application scenarios with isolated battery cells.


The remainder of this paper is organized as follows: 
Section II presents the framework and details of the proposed topologic model and the greedy algorithm. 
In Section III, a case study of using the proposed model and algorithm to enumerate the MAC of a new and complex structure is demonstrated. 
The calculation results and scenarios such as battery cells isolation also are discussed. 
Finally, the concluding remarks are drawn in Section IV.


\section{Methodology}

The overall MAC modeling process based on an RBS is shown in Fig. \ref{fig:main}, which can be divided into four main steps.
In the first place, the actual switching circuit typology of the RBS is converted to a directed graph model, in which the connected relationships between batteries and switches are described by nodes and the performance parameters of the batteries are retained.
Subsequently, the allowable current of the RBS is regarded as an objective function to be obtained based on the previous connected relationships and parameters.
Then, the shortest path (SP) of each battery in the RBS is obtained by Dijkstra algorithm.
In the end, an optimized switching circuit strategy of the RBS is implemented by greedily selecting the SPs to achieve MAC and quantitatively calculated in the equivalent circuit.
% 问题出在 要用最简短、读者能接受的话描述清楚方法
% 重写上面一段，注意描述方法时的逻辑性


% main 主图只保留文字

\begin{figure}[htbp]
    \centering
    \begin{subfigure}[b]{\textwidth}
        \includegraphics[width=\textwidth]{../attachments/main.png}
        \caption{}
        \label{fig:main}
    \end{subfigure}
    \\ 
    \begin{subfigure}[b]{\textwidth}
        \includegraphics[width=\textwidth]{../attachments/battery_simple.png}
        \caption{}
        \label{fig:battery_simple}
    \end{subfigure}
    % caption 简写
    \caption{ (a)Diagram of this method, which contains four main steps.
        Step 1: The RBS structure is converted to a topologic model.
        Step 2: Constraints and objective function are obtained based on the previous topologic model.
        Step 3: The shortest path of each battery in the RBS is obtained by Dijkstra algorithm.
        Step 4: The MAC is achieved by greedily selecting the shortest paths to open/close switches.
        (b) The equivalent circuit of a battery in this method, with $u_{b,i}$ and $r_{b,i}$ representing the voltage and internal resistance of the battery $i$ respectively.
        The capacitor in Thevenin model is ignored.
    }
\end{figure}

\subsection{Directed graph Model}

% 以下内容删去，改为对三层关系的说明
% 说清三层关系：传统有向图（电池做结点）、Xu的有向图、本文包含物理信息的有向图
As demonstrated in Figs. \ref{fig:arch-f} and \ref{fig:arch-e}, RBS is constructed by a number of batteries and switches in a dynamically adjustable connection.
To establish a processable circuit, these batteries and switches are transformed into ideal elements under reasonable assumptions.
The resulting circuit structure is then described in matrix form, and the related equations are provided.


% 说明电池的等效电路化处理
% 等效成电路，用电路方法处理；借助等效电路方法
As shown in Fig. \ref{fig:battery_simple}, the battery in the RBS can be equivalent to a black-box circuit consisting of two resistors (i.e. $r_1$ and $r_2$), and a capacitor (i.e. $C$), kwon as Thevenin model\cite{hongwenheStateofChargeEstimationLithiumIon2011,mousavig.VariousBatteryModels2014}. % 电路相关写法参考 https://eng.libretexts.org/Bookshelves/Electrical_Engineering/Introductory_Electrical_Engineering/Electrical_Engineering_(Johnson)/03%3A_Analog_Signal_Processing/3.07%3A_Equivalent_Circuits_-_Resistors_and_Sources
% Under ... situations, ... , therefore, such a model can be simplified by ...
% 说明为什么要简化，在说明怎么简化 
% 稳态瞬态，整体结构的特征，而非局部
In this way, the battery $i$ in the RBS is modeled by the series connection in between a constant voltage source $u_{i}$ and a resistor $r_{i}$,  as shown in Fig. \ref{fig:battery_simple}
Furthermore, the state of switch $j$ in the RBS is represented by a binary variable $x_j$, where 0 for ON and 1 for OFF, respectively.
When the switch is closed, it can be regarded as a resistor with a very small resistance value $r_s$.


For a given RBS structure, the directed graph model for the RBS is constructed as a directed graph $G(V,E)$ in such a way that:
\begin{enumerate}
    \item Nodes: % 重写，node represent the connection with 3种情况；for a RBS with N nodes ...
        Among them, the nodes $v_1$ and $v_N$ represent the anode and cathode of the RBS respectively, whereas the other nodes $v_2,\cdots,v_{N-1}$ represent the points connecting batteries and/or switches.
    \item Edges: % 重写，边的方向由电流确定；边的属性三个分别说
        the directed edges represent batteries, switches and the external electrical load in the output circuit based on whether the current direction is constrained or not. 
        For instance, the battery is represented by a directed edge from its one electrode to the other to describe the current direction through that battery.
        This directed edge is draw from the cathode to anode when the battery is in the discarded mode, and on the other way around when the battery is in the charging mode.
        The directed edge has two attributes $(u_i, r_i)$, where $u_i$ and $r_i$ represent battery $i$'s electromotive force and internal resistance, respectively.
        On the other hand, switches are allowed to work under bi-directional currents, so they are represented by a pair of directed edges with two-way directions.
        % ...
        As a conclude, for a given RBS structure has $N_b$ batteries and $N_s$ switches, the total number of directed edges is $N_b+2N_s+1$, where 1 refers to the external electrical load. 

        % When the battery is in operation, the internal current direction must be from the negative electrode to the positive electrode, so it is represented by a directed edge from the negative to the positive ; this edge has attributes $(u_b, r_b)$, where $u_b$ and $r_b$ represent battery $b$'s electromotive force and internal resistance.
        % Switches have no constraints on the current direction, so they are represented by a pair of directed edges with opposite directions; these edges both have attribute $(0, r_s)$, where $r_s$ represents the resistance of switch as mentioned above.
        % To fully solve for the current and voltage, an external electrical appliance equivalent as a resistor $R_0$ is connected to the anode and cathode of the RBS and represented by a directed edge from the anode $v_N$  to the cathode $v_1$ of the RBS.
        % Similarly, this edge has attribute $(0, R_0)$.
\end{enumerate}

\subsection{Constraints and Objective Function}

% hat
% 约束和目标函数-在hat部分说
% 提前说下约束和目标函数是啥
The constraints and objective function are obtained by analyzing the currents of batteries and external electrical load.
% 添加过渡句
% 文献或教科书上导纳矩阵的定义式
For a directed graph with $N$ nodes and $N_b+2N_s+1$ directed edges, an incidence matrix $\bm{A}$, as shown in Eq. \ref{eq:A}, is defined to ... % 定义导纳矩阵的作用
% 更换 a_ij 的下角标ij，这个已经被电池和开关用了
\begin{align}\label{eq:A}
    a_{ij}=
    \begin{cases}
        1,  & \text{edge $j$ leaves vertex $i$},\\
        -1, & \text{edge $j$ enters vertex $i$},\\
        0,  & \text{otherwise}.
    \end{cases}
\end{align}
% 矩阵A的处理，要写得流畅
% According to the XX (连通关系？) principle, the sum of currents at each node is zero.
% 为保证后续矩阵计算满秩，不失一般性地将最后一行删除
Since each column of $\bm{A}$ sums to zero, the last line are deleted.
Furthermore, because of a couple of two-way directed edges for each switch, the $N_s$ columns corresponding to the switches are also deleted. % 好好写这句话，开关j在矩阵A中对应两列，且两列互为相反数，删除其中一列可以在不丢失信息的条件下降低矩阵维数，进而降低计算量
Finally, the reduced incidence matrix $\bm{A}_{(N-1)\times(N_b+N_s+1)}$ are used in the following calculation.
As a result, $\bm{A}$ can be reduced to a $(N-1)\times(N_b+N_s+1)$ matrix for further calculation of ... % 补全
By distinguishing the components of the batteries, switches and external electrical load, $\bm{A}$ is rewritten as:
\begin{equation}
    \bm{A} =
    \begin{bmatrix}
        \bm{A}_b & \bm{A}_s & \bm{A}_o
    \end{bmatrix}.
\end{equation}


According to Kirchhoffs law, we have
\begin{align}\label{eq:Kirchhoffs_law}
    \begin{cases}
        \bm{A} \bm{I} = \bm{0}, \\
        \bm{U}        = \bm{A}^\T \bm{U}_n,
    \end{cases}
\end{align}
where $\bm{I}$ and $\bm{U}$ indicate the current and voltage arrays of the $N_b+N_s+1$ edges, respectively;
$\bm{U}_n$ is the voltage array of the $N-1$ nodes.
These directed edges are treated as generalized branches and expressed in matrix form as follows
\begin{equation}\label{eq:generalized_branches}
    \bm{I} = \bm{Y}\bm{X} \bm{U} - \bm{Y}\bm{X} \bm{U}_s +\bm{I}_s,
\end{equation}
where $\bm{I}$ and $\bm{U}$ are the column vectors about $1+N_b+N_s$ edges' current and voltage, respectively;
$\bm{U}_s$ and $\bm{I}_s$ denote the source voltage and source current of the generalized branches, respectively;
$\bm{Y}$ is the admittance matrix of the circuit, and $\bm{X}$ is the state matrix defined as
\begin{equation}\label{eq:X}
    \bm{X} = \diag(
    \underbrace{1, \cdots, 1}_{N_b~\text{of}~1},
    \underbrace{1, 0 \cdots, 1}_{N_s~\text{of}~0/1},
    1)
    =\begin{bmatrix}
        \bm{E} & & \\
        & \bm{X}_s &\\
        & &\bm{E}
    \end{bmatrix}.
\end{equation}
where $\bm{E}$ is the identity matrix, and $\bm{X}_s$ is a diagonal matrix with $N_s$ elements of 0 or 1.


Furtherly, by assuming that the electromotive force and internal resistance of all batteries in the RBS are identical, denoted as $u_b$ and $r_b$ respectively, the output current $I_o$ and each battery's current $\bm{I}_b$ can be calculated by solving the Eqs. \ref{eq:Kirchhoffs_law} and \ref{eq:generalized_branches} eventually.
Let
\begin{equation}\label{eq:Yn}
    \bm{Y}_n (\bm{X}_s) = \frac{1}{R_o} \bm{A}_o\bm{A}_o^\T + \frac{1}{r_b} \bm{A}_b\bm{A}_b^\T + \frac{1}{r_s}\bm{A}_s\bm{X}_s\bm{A}_s^\T,
\end{equation}
where $R_o$ is the equivalent resistance of the external electrical load.
Then, if $\bm{Y}_n$ is an invertible matrix,
\begin{align} % 统一下角标，不用在公式中表示矩阵形状；单位矩阵的符号
    I_o(\bm{X}_s)      & = \frac{u_b}{R_o r_b} \bm{A}_o^\T \bm{Y}_n^{-1}(\bm{X}) \bm{A}_b \bm{I}_{N_b\times 1};\label{eq:I_o}\\
    \bm{I}_b(\bm{X}_s) & = \frac{u_b}{r_b^2}[\bm{A}_b^\T \bm{Y}_n^{-1}(\bm{X}) \bm{A}_b\bm{I}_{N_b \times 1}  -r_b \bm{I}_{N_b \times 1}],\label{eq:I_b}
\end{align}
where $\bm{I}_{N_b\times 1}$ is an array with all elements equaling to 1.


Then an indicator $\eta$ is defined by the ratio of $I_o$ and $\max (\bm{I}_b)$ shown in Eq. \ref{eq:eta}, to characterize the current output capacity of the RBS structure under different switching states:
\begin{equation}\label{eq:eta}
    \eta = \frac{I_o}{\max (\bm{I}_b)}.
\end{equation}
Finally the problem of solving MAC can be formulated as
\begin{align}
    & \max \eta \label{eq:max_eta}\\
    \text{s.t.} & \max (\bm{I}_b) \leq I_m, \label{eq:Ib_leq_Im}
\end{align}
where $I_m$ is the maximum allowable current of the battery.
However, it is computationally difficult to solve \ref{eq:max_eta} because of the presence of matrix $\bm{Y}_n^{-1}$. % 在此处说明 Yn-1的难求解，也是由于这一非线性项的存在，传统的优化方法无法求解
As the number of batteries and switches in the RBS increase, the order of the matrix increases, and the time costed to compute increases sharply.
A greedy algorithm will be proposed to solve this problem in the next subsection. % 扩写：为解决这个问题，需要从xx入手，采用greedy algorithm 代替xx，greedy algorithm 具体的实现过程如下节所示。

% Herein provides the solution procedure of …: 1. 2.
% 考虑这部分怎么写，想不出就直接删了吧。
% The integrability of the matrix $\bm{Y}_n$ is explained here.
% Although the above solution procedure requires the matrix $\bm{Y}_n$ to be invertible, it is still possible to encounter integrable $\bm{Y}_n$ in the calculation.
% The physical meaning of this case corresponds to the fact that due to the excessive number of switches in OFF, the solved circuit structure forms circuit branches independent of the main circuit, i.e., the circuit connected to the anode and cathode of the RBS. 
% Since these independent branches are not connected to the main circuit, the voltage potentials of these branches cannot be determined and theoretically an infinite number of sets of solutions exist. 
% Benfit from the independence, these solutions have no influence on the results of the main circuit. 
% Since only the currents and voltages of the main circuit are of interest, only one of these solutions needs to be chosen for subsequent calculation.

\subsection{Shortest Path}
% 计算SP的部分单独一个 subsection
% 添点内容，修改下面两句话
A path is defined by the complete route passing through one battery (or a consecutive series of batteries) and closed switches from the anode $v_1$ to cathode $v_N$ of the RBS.
Assuming a situation that battery $i$ is connected to the anode $v_1$ and the cathode $v_N$ of the RBS by a path $p$ in the graph model.
Then the distance $\omega$ of the path $p$ is defined by the following equation: % 给出使用 Ns的原因，在这句开头，利用RBS的灵活性，通过额外的开关实现一条path上的电池数尽可能少，因此对路径p上的电池数量进行惩罚，设其权重为Ns，而路径p上的开关数量的权重设为1，从而使得最短路径表示的是电池数量最少的情况。 #TODO: 好好想这句话怎么写清楚
\begin{equation}\label{eq:weight}
    \omega(p) = N_s \cdot n_b (p) + n_s (p),
\end{equation}
where $N_s$ is the total number of switches in the system; $n_b(p)$ and $n_s(p)$ are number of batteries and switches in the path $p$ respectively. 
$SP_i$ is defined as the path with the minimum $\omega$ for battery $i$.
\begin{equation}\label{eq:def_sp}
    SP_i = \mathop{\arg\min}_{p \in P_i} \omega(p),
\end{equation}
where $P_i$ is the set of all paths from $v_1$ to $v_N$ which pass through the directed edge $i$.
The Dijkstra algorithm can be used to implement the $SP_i$. % 简短说下过程，给参考文献


% SP 的作用，好好解释，下段重写(是不是该挪到下一subsection)
According to the definition, $SP_i$ gives the simplest strategy by which the control of battery $i$ is achieved with a minimum of switches while minimizing the influence of other batteries.
From the perspective of series/parallel, the more batteries are connected into circuit via their $SP$s, the more batteries are connected in parallel.
Since batteries can provide more total output current when connected in parallel than in series, the algorithm greedily selects as many cells as possible to be connected into to the overall circuit via their $SP$s to obtain the MAC.
The dichotomy method is also performed to faster find the right number of $SP$s. % 添加对贪心算法的步骤介绍，具体某一步说明采用了二分法…

\subsection{Greedy Algorithm}\label{subsec:greedy_solution}

In this subsection, a greedy algorithm is proposed based on shortest paths ($SP$s), which is given here firstly. % 这句话改成 greedy algorithm 在整个 MAC 计算中的作用

After finding the potential SPs combinations in correspondence MAC, the state variable $\bm{X}_s$ of the switches can be determined, and the optimization problem \ref{eq:max_eta} can be solved using Eq. \ref{eq:eta}, \ref{eq:I_o} and \ref{eq:I_b}.
The overall flowchart is shown in Fig. \ref{fig:flowchart}, and the corresponding pseudo-code of the algorithm is shown in Appendix \ref{alg:eta_RBS}. % 这句话应该放前面说，采用“总-分”架构，先给出流程图，然后再结合流程各步骤介绍每类具体算法的应用过程

\tikzset{
  meta box/.style={
    draw,
    black,
    very thick,
    text centered,
  },
  punkt/.style={
    meta box,
    rectangle,
    rounded corners,
    inner sep=.25em,
    minimum height=2em,
    minimum width=4em,
    align=center,
    text width=10em
  },
  round/.style={
    meta box,
    circle,
    minimum size=0,
    inner sep=0pt, 
    outer sep=0pt
  },
  every fit/.style={
    draw,
    thick,
    dashed,
    gray,
    inner xsep=.5em,
    inner ysep=.75em
  }
}
\begin{figure}
\begin{tikzpicture}[font=\small, node font=\small, node distance=1.5em]
    \node[punkt]     (input) {Input: RBS structure};
    \node[punkt, below=0.3of input] (get_SP) {get $SP$s by Eqs. \ref{eq:weight} and \ref{eq:def_sp} and Dijkstra Search};
    \node[punkt, below=0.3of get_SP] (get_A) {get $\bm{A}$ from Eq. \ref{eq:A}};
    \node[punkt, below=0.3of get_A] (get_Nset) {init $N_{set}=N_b$ };
    \node[punkt, below=0.3of get_Nset] (get_cb) {get $c_b$s by combinating $N_{set}$ batteries from $N_b$};
    \node[draw, diamond, aspect=2, below=0.3of get_cb] (is_check_all_cb) {are all $c_b$s checked?};
    \node[draw, diamond, aspect=2, right=1of is_check_all_cb] (is_Nset_converged) {is $N_{set}$ converged?};
    \node[punkt, above=of is_Nset_converged] (reset_Nset) {reset $N_{set}$ by dichotomy};
    \node[punkt, text width=15em, below=0.3of is_check_all_cb] (get_Xs) {
        select an unchecked $c_b$, and get its $\bm{X}_m$ by \\ 
        if switch $j$ $\in \bigcup_{i\in c_b}SP_i$:\\
        $\bm{X}[j]=1$ else $0$};
    \node[punkt, below=0.3of get_Xs] (get_Yn) {get $\bm{Y}_n$ by Eq.\ref{eq:Yn}};
    \node[draw, diamond, aspect=2, below=0.3of get_Yn] (is_Yn_invertible) {is $\bm{Y}_n$ invertible?};
    \node[punkt, right=1.3of is_Yn_invertible] (construct) {construct an effective solution};
    \node[punkt, below=0.3of is_Yn_invertible] (get_I) {get $I_o$ and $\bm{I}_b$ by Eqs. \ref{eq:I_o} and \ref{eq:I_b}};
    \node[draw, diamond, aspect=2, below=0.3of get_I] (is_leq_Im) {is $\max \bm{I}_b \leq I_m$?};
    \node[punkt, right=1.3of is_leq_Im] (drop_eta) {drop this $\eta$};
    \node[punkt, below=0.3of is_leq_Im] (get_eta) {get $\eta$ by Eq.\ref{eq:eta}};
    \node[punkt, below=0.3of get_eta] (update_max_eta) {update $\max \eta$};
    \node[punkt, right=1of is_Nset_converged] (output) {Output: $\max \eta$};
    \node[round,left=1.5of update_max_eta](point1){};

    \graph{
      (input) -> (get_SP) -> (get_A) -> (get_Nset) -> (get_cb) -> (is_check_all_cb) ->["No"] (get_Xs) -> (get_Yn) -> (is_Yn_invertible) ->["Yes"] (get_I) -> (is_leq_Im) ->["Yes"] (get_eta) -> (update_max_eta);
      (is_check_all_cb) ->["Yes"] (is_Nset_converged) ->["No"] (reset_Nset) -> (get_cb);
      (is_Yn_invertible) ->["No"] (construct) ->[to path={|- (\tikztotarget)}] (get_I);
      (is_leq_Im) ->["No"] (drop_eta) ->[to path={|- (\tikztotarget)}] (update_max_eta);
      (is_Nset_converged) ->["Yes"] (output);
      (update_max_eta) -- (point1) ->[to path={|- (\tikztotarget)}] (is_check_all_cb);
    };
\end{tikzpicture}
\caption{The computational flowchart of the MAC if an RBS.}\label{fig:flowchart}
\end{figure}

\section{Case Study}

This section presents a case study to demonstrate the effectiveness of the proposed method.
A more intricate structure, which integrates the two previously proposed structures, is proposed.
The effectiveness of the aforementioned algorithm is substantiated on this structure to confirm its applicability in practical scenarios.
Moreover, the algorithm's versatility is also established through its application in complex cases such as the presence of isolated battery cell.

\subsection{Determination of a new RBS structure}

\begin{figure}[htbp]
    \centering
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/arch-ef.png}
        \caption{}
        \label{fig:arch-ef}
    \end{subfigure}
    \hspace{0.05\textwidth}
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-topo.png}
        \caption{}
        \label{fig:ef-topo}
    \end{subfigure}
    \caption{
        (a) The new RBS structure proposed in this paper, which is obtained by replacing the batteries in Fig. \ref{fig:arch-e} with the structure in Fig. \ref{fig:arch-f}, as shown in the dashed boxes in the figure.
        (b) The corresponding topologic model of the new RBS structure, which is a directed graph.
        The nodes represent the connection points of the battery cells and/or the switches.
        The green,gray and blue directed edges represent the battery cells, the switches and the external electrical appliance, respectively.
    }
\end{figure}

The RBS structure proposed by Lawson et al\cite{lawsonSoftwareConfigurableBattery2012}, shown in Fig. \ref{fig:arch-e}, easily enables the isolation of arbitrary cells or the addition of redundant cells to the system, but these cells are limited to being connected in series only and the switch between cells connection modes is not flexible. 
In contrast, the structure proposed by Visairo et al\cite{visairoReconfigurableBatteryPack2008}, shown in Fig. \ref{fig:arch-f}, allows the flexibility to switch the cells between series, parallel and mixed series-parallel modes, thus allowing dynamic voltage adjustment according to the external load and improving energy conversion efficiency, but is not as simple as the structure by Lawson et al in terms of isolating cells or adding redundancy.
In order to combine the advantages of both structures, a new structure is obtained by replacing the batteries in Fig. \ref{fig:arch-e} with the structure in Fig. \ref{fig:arch-f}, as shown in Fig. \ref{fig:arch-ef}.
This more complex structure has the structure of Lawson et al.\cite{lawsonSoftwareConfigurableBattery2012} as the main frame and the structure of Visairo et al.\cite{visairoReconfigurableBatteryPack2008} as the substructure.
In this way, the circuit topology of the substructure (i.e. the structure in the box in Fig. \ref{fig:arch-ef}) can be changed to enable dynamic and flexible voltage adjustment according to the load, while at the same time taking advantage of the ease of battery isolation and increased redundancy of the main frame.
The next subsections will use this structure with 4 battery cells and 19 switches as an example to demonstrate the effectiveness of the proposed algorithm.

\subsection{Calculation details and result}

The graph in Fig. \ref{fig:ef-topo} represents the topologic model based on the new RBS structure mentioned in the last subsection (Fig. \ref{fig:arch-ef}).
The model is presented in the form of a directed graph, capturing the connection relationship between the battery and switch in the circuit.
Battery cell 1, 2, 3, and 4 are represented by green directed edges in the graph, while nineteen switches are represented by gray directed edges with opposite directions.
The external electrical appliance is considered as a directed edge from the cathode of the RBS ( node $18$ in the graph) to the anode ( node $1$ in the graph), represented as the blue directed edge in the graph.
Totally, there are 19 nodes and 43 edges in the graph.


Based on the node-edge relationship given in Fig. \ref{fig:ef-topo}, the incidence matrix $\bm{A}$ can be obtained according to Eq. \ref{eq:A}:
\begin{equation}
    \bm{A} = 
    \begin{bmatrix}
        \bm{A}_b & \bm{A}_s & \bm{A}_o
    \end{bmatrix},
\end{equation}

\begin{equation}
    \bm{A}_b^\T = 
    \begin{bmatrix}
        0 & 0 & 0 & 0 & 1 & 0 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 1 & 0 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 &-1 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 &-1 & 0 & 0 \\
    \end{bmatrix},
\end{equation}

\begin{equation}
    \bm{A}_s^\T = 
    \begin{bmatrix}
        1 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 1 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 1 & 0 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 1 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 1 & 0 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 1 & 0 & 0 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 &-1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 &-1 & 0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 &-1 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 &-1 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 &-1 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 &-1 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 &-1 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 &-1 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 &-1 \\
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 \\
    \end{bmatrix},
\end{equation}

\begin{equation}
    \bm{A}_o^\T = 
    \begin{bmatrix}
       -1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
    \end{bmatrix}.
\end{equation}
The state matrix $\bm{X}$ is determined by the switches' state, that is, the specific configuration of the RBS.
For example, when switch $S_1$, $S_3$, $S_5$, $S_6$, $S_8$, $S_9$, $S_{11}$, $S_{13}$, $S_{14}$, $S_{16}$, $S_{17}$ and $S_{19}$ are ON, and the rest of the switches are OFF, the state matrix $\bm{X}$ is given by
\begin{equation}
    \bm{X} = diag(
    \underbrace{1,0,1,0,1,1,0,1,1,0,1,0,1,1,0,1,1,0,1}_{\text{switches}},
    \underbrace{1,1,1,1}_{\text{batteries}},
    1
    ).
\end{equation}
By substituting the above specific values of $\bm{A}$ and $\bm{X}$ above into Eqs. \ref{eq:Yn}, \ref{eq:I_o}, \ref{eq:I_b} and \ref{eq:eta} in turn, the $\eta$ at the current situation, i.e. battery cell $B_1$ and $B_2$, $B_3$ and $B_4$ are connected in parallel with each other, and then connected in series to supply the external electrical appliance, can be obtained after the sequential calculation.
The results are shown in Tab. \ref{tab:given_x}.

\begin{table}[htbp]
  \centering
    \caption{Calculating result of the output current $I_o$, battery current $\bm{I}_b$ and ratio $\eta$ for a specificed switches state $\bm{X}_m$ in the structure combining Lawson et al.\cite{lawsonSoftwareConfigurableBattery2012} and Visairo et al.\cite{visairoReconfigurableBatteryPack2008} with 4 battery cells and 19 switches.}
    \begin{tabular}{cc}
    \toprule
        Structure & 4 battery cells and 19 switches  \\
        % Structure & combining Lawson et al.\cite{lawsonSoftwareConfigurableBattery2012} and Visairo et al.\cite{visairoReconfigurableBatteryPack2008} with 4 battery cells and 19 switches  \\
    \midrule
    Switch ON & 1,3,5,6,8,9,11,13,14,16,17,19 \\
        $\bm{X}_s$ & $\diag(1,0,1,0,1,1,0,1,1,0,1,0,1,1,0,1,1,0,1)$ \\
    \midrule
        $I_o$ & $2u_b/(R_o+r_b)$ \\
        $\bm{I}_b$ & $[u_b/(R_o+r_b),u_b/(R_o+r_b),u_b/(R_o+r_b),u_b/(R_o+r_b)]$ \\
        $\eta$     & 2 \\
    \bottomrule
    \end{tabular}%
  \label{tab:given_x}%
\end{table}%

The above gives the procedure for calculating the current and $\eta$ when the specified switches are given ON or OFF.
However, in order to calculate the MAC of the structure, i.e. the maximum $\eta$, it is necessary to find the corresponding switch state using a greedy strategy, as mentioned in subsection \ref{subsec:greedy_solution}.

Firstly, the weight $N_s$ in Eq. \ref{eq:weight} represents the total number of switches in the system, which is 19. 
By using this formula and the Dijkstra search strategy, the $SP$s of each cell can be obtained, as shown in Figs. \ref{fig:sp1} to \ref{fig:sp4}.
According to the greedy strategy, as many $SP$s as possible should be selected to get the MAC. 
In the first iteration, the $SP$s of all four batteries are selected, and the switch states on the paths are set to ON. 
The corresponding $\bm{X}_s$ are calculated using the previous method, and the currents of the batteries are obtained as $u_b/r_b$, $u_b/r_b$, $u_b/r_b$, and $u_b/r_b$. 
Since all batteries are short-circuited and the current of the battery exceeds the maximum allowed current $I_m$, this solution does not satisfy constraint \ref{eq:Ib_leq_Im} and is discarded. 
The second iteration is carried out using the dichotomy method, and two batteries are selected for the combination. 
Assuming that the selected combinations are $(B1, B2)$, the $\bm{X}_s$ obtained according to the $SP$s are substituted into the previous calculation, and the current of each battery is $u_b/r_b$, $u_b/r_b$, $0$, and $0$. 
This solution meets the condition. 
After that, the case of selecting three cells is considered. 
By similar calculations, it is determined that all solutions do not satisfy the constraint when three cells are selected. 
Finally, the MAC of this structure is $\eta=2$, and the related result is shown in Fig. \ref{fig:ef-mac} and Tab. \ref{tab:find_mac}.

\begin{figure}[htbp]
    \centering
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-sp1.png}
        \caption{}
        \label{fig:sp1}
    \end{subfigure}
    \hspace{0.05\textwidth}
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-sp2.png}
        \caption{}
        \label{fig:sp2}
    \end{subfigure}
    \\
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-sp3.png}
        \caption{}
        \label{fig:sp3}
    \end{subfigure}
    \hspace{0.05\textwidth}
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{../attachments/ef-sp4.png}
        \caption{}
        \label{fig:sp4}
    \end{subfigure}
    \caption{
        The $SP$s of battery cell (a)$B_1$ (b)$B_2$ (c)$B_3$ (d)$B_4$ in the new structure's topological model, which is highlighted in red.
        }
\end{figure}

\begin{table}[htbp]
  \centering
    \caption{MAC Calculating result of the output current $I_o$, battery current $\bm{I}_b$ and ratio $\eta$ in the structure combining Lawson et al.\cite{lawsonSoftwareConfigurableBattery2012} and Visairo et al.\cite{visairoReconfigurableBatteryPack2008} with 4 battery cells and 19 switches.}
    \begin{tabular}{cc}
    \toprule
        % Structure & combining Lawson et al.\cite{lawsonSoftwareConfigurableBattery2012} and Visairo et al.\cite{visairoReconfigurableBatteryPack2008} with 4 battery cells and 19 switches  \\
        Structure & 4 battery cells and 19 switches  \\
    \midrule
    Switch ON & 1,3,5,6,8,9,10,12,18,19 \\
    $\bm{X}_s$ & $\diag(1,0,1,0,1,1,0,1,1,1,0,1,0,0,0,0,0,1,1)$ \\
    \midrule
        $I_o$ & $2u_b/(2R_o+r_b)$ \\
        $\bm{I}_b$ & $[u_b/(2R_o+r_b),u_b/(2R_o+r_b),0,0]$ \\
        $\eta$     & 2 \\
    \bottomrule
    \end{tabular}%
  \label{tab:find_mac}%
\end{table}%

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\textwidth]{../attachments/ef-mac.png}
    \caption{
        The finally calculation result of MAC for the new structure with four battery cells and 19 switches.
        The red lines represent the branches through which the current flows, and the switches on these branches are ON. 
        In this situation, the RBS outputs MAC to the outside, which is $\eta=2$.
    }\label{fig:ef-mac}
\end{figure}

\subsection{Discussion}

The correctness of the results shown in Fig. \ref{fig:ef-mac} is obvious. 
When B1 and B2 or B3 and B4 are connected in parallel, the RBS can output the maximum current, which is $\eta=2$, i.e. twice the current output of a single battery in RBS.
While adding more batteries to the main circuit can only form a series structure and will not improve the MAC.
It is worth noting that when solving for MAC, $\eta$ is used as the objective function instead of $I_o$, which makes the result of MAC more reasonable. 
According to the results shown in Tab. \ref{tab:find_mac}, $I_o$ and $\bm{I}_b$ are affected by the equivalent resistance $R_o$ of external electrical appliance, the battery's electromotive force $u_b$, and internal resistance $r_b$. 
This means that if $I_o$ is used as the objective function, even for the same RBS structure, the MAC result and corresponding switch state could be changed due to different external electrical appliances. 
This increases the difficulty and uncertainty in RBS structure design. 
On the contrary, by using $\eta$ as the objective function, which dividing $I_o$ and $\max\bm{I}_b$, the influence of these factors on the results is eliminated, as shown in Tabs. \ref{tab:given_x} and \ref{tab:find_mac}.
$\eta$ only reflects the maximum output current capability of the RBS structure.
Assuming that the maximum allowed current of battery cells in the RBS is $I_m$, the maximum output current of the RBS structure can be calculated as $\eta I_m$ by calculating the $\eta$ of the structure. 
Therefore, compared to $I_o$, $\eta$ is more suitable for structure design. 
Most of the currently proposed RBS structures\cite{ciNovelDesignAdaptive2007,alahmadBatterySwitchArray2008,kimDependableEfficientScalable2010b,kimBalancedReconfigurationStorage2011a,taesickimSeriesconnectedSelfreconfigurableMulticell2012a,6843711} have simple topological characteristics, and the calculation of MACs are relatively simple, even intuitive. % #TODO 添加cite
However, when complex and flexible structures need to be designed for application scenarios such as equalization or isolation of specific battery cells, the estimation of MAC will become complex and complicated. 
The method proposed in this paper can effectively solve any RBS structure and estimate MAC universally, paving the way for the structure design of more complex and flexible RBSs.

% 对比Tab. 1和 Tab. 2，可以发现，对于这两种开关状态 $\bm{X}_s$，在电阻和电动势相同的情况下，前者的Io更大。
% 这主要是由于在Tab. 1的情形下，四个电池以两并两串的形式接入主电路，提供了更多的电动势。
% 相应的，每个电池的电流也更大。
% 此时，如果仅使用 Io 作为目标函数，则  （） #TODO：讨论怎么说

When the RBS has isolated battery cells, the original topology of the structure is altered. 
However, the method proposed in this paper can still be used to calculate the MAC of the new structure. 
The MAC after the isolation operation can be obtained by calculating the new structure following the procedures described in the previous subsection.
During the calculation process, the isolated battery cell(s) do not participate in the calculation, i.e., their nodes, edges, and $SP$s are not considered. 
The MACs under various isolated battery cell(s) are calculated on the structures proposed by Lawson et al. (Fig. \ref{fig:arch-e}), Visairo et al. (Fig. \ref{fig:arch-f}), and the new structure that integrates the previous two structures (Fig. \ref{fig:ef-topo}), as shown in Fig. \ref{fig:isolated_mac}. 
For the structure proposed by Lawson et al., the MAC remains the same as that without isolated battery cells, i.e., $\eta=1$, when the number of isolated battery cells increases, until all the cells in the RBS are isolated.
For the structure proposed by Visairo et al., the MAC decreases as the number of isolated battery cells increases, until $\eta=0$.
While the new structure has two cases of isolating two cells, one is to isolate two cells within the same substructure, in which case $\eta=2$; the other is to isolate one cell in each of the two substructures, in which case $\eta=1$. 
Overall, the MAC of the new structure is positioned between the structures proposed by Lawson et al. and Visairo et al..
It can be seen that the MAC of the structure in Fig. \ref{fig:arch-e} is the most stable, and the structure has advantages in isolation and redundancy backup, but its MAC is the smallest. 
The structure proposed shown by Fig. \ref{fig:arch-f} can output the largest MAC but is susceptible to the number of isolated battery cells. 
However, the structure proposed by this paper has certain advantages in both aspects, being insensitive to the number of isolated battery cells while simultaneously achieving a larger MAC.

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.8\textwidth]{../attachments/isolated_mac.png}
    \caption{
        The variation of MAC with the number of isolated battery cells for different RBS structures, including the structure proposed by Lawson et al., Visairo et al. , and the new structure in this paper.
    }\label{fig:isolated_mac}
\end{figure}

\section{Conclusion}

This paper firstly proposes a method to calculation the MAC of RBS according to its architecture. 
To find the circuit in RBS that enable the MAC, a greedy strategy incorporate with the topologic model is developed to. 
The effectiveness of proposed method is tested on a more complex RBS structure based on two proposed structure.
This work presents an effective approach to evaluate the MAC of RBS, which is essential for design and management of the RBS. 
Future research could focus on developing new performance indicators for evaluating RBS performance using the currents and voltages obtained by this method, as well as modifying the equivalent model of the battery to enable more accurate simulations of RBS, including transient analysis.

\section{Appendix} %TODO 待修改
\begin{algorithm}
    \caption{Get the max available currents of a certain RBS}\label{alg:eta_RBS}
    \KwData{Directed graph model $G(V,E)$ of the RBS}
    \KwResult{$\max \eta$}
    \For{$i \in E_b$}{
        $P_i \leftarrow \{path| \text{starts at $v_1$ and ends at $v_n$} \}$\;
        $SP_i \leftarrow p_i \text{ which has the minimum}~\omega(p_i)~\text{among all}~p_i \in P_i. $
    }
    get $\bm{A}$ by Equation \ref{eq:A}\;
    \While{not yet determine $\max \eta$ }
    {
        $N_{sel} \leftarrow \text{number of selected $SP$s calculated by dichotomy}$\;
        $C_b    \leftarrow \text{set of all combinations of $N_{sel} $~batteries from $N_b$}$\;
        \For{$c_b \in C_b$}{
            $\bm{x}_s \leftarrow \text{list of all switches' state: $x_s[j]=1$ if $ j \in \bigcup_{i\in c_b}SP_i $ else 0}$\;
            $\bm{X} \leftarrow diag[1,1,\cdots,1,\bm{x}_s] $\;
            get $\bm{Y}_n$ by Equation \ref{eq:Yn}\;
            \eIf{$\bm{Y}_n$ is invertible}{
            }{construct an effective solution}
            get $I_o$ by Equation \ref{eq:I_o}\;
            get $\bm{I}_b$ by Equation \ref{eq:I_b}\;
            \eIf{$\max(\bm{I}_b)\leq I_m$}{
                $\eta \leftarrow I_o/\max(\bm{I}_b)$\;
            }{break}
        }
    }
\end{algorithm}

\bibliographystyle{ieeetr}
% \bibliography{../attachments/my_ref}
\bibliography{my_ref}

\end{document}
